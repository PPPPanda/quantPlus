# Iter5 诊断：P2401 & P2601（cta_chan_pivot）

本报告由 `experiments/iter5_diagnose_contracts.py` 自动生成，回测逻辑基于 `scripts/backtest_all_contracts.py`，并在逐笔记录上增加了入场上下文特征用于诊断。

## 数据源

- P2401: `p2401_1min_202308-202312.csv`

- P2601: `p2601_1min_202507-202512.csv`

## 参数说明

- BEST（与 backtest_all_contracts.py 一致）：activate_atr=2.5, trail_atr=3.0, entry_filter_atr=2.5, pivot_valid_range=6, min_bi_gap=4, enable_2b2s=True

- P2601 对比：仅修改 min_bi_gap：4 vs 7（其余同 BEST）


---

## P2401 深度诊断（BEST）

逐笔导出：`iter5_P2401_trades_best.csv`


- 总交易数：130

- 总PnL：-621


### 1) 信号类型统计

```
signal_type  n    pnl win%   avg avg_win avg_loss   pf payoff
         2B 41 -478.0 22.0 -11.7    26.8    -23.2 0.34   1.16
         3S 28 -276.7 17.9  -9.9    47.9    -22.4 0.46   2.13
         3B 23  -41.3 39.1  -1.8    31.4    -23.1 0.87   1.36
         2S 38  174.6 36.8   4.6    53.3    -23.8 1.31   2.24
```


### 2) 月度PnL拆解（按 exit_time 归属月份）

```
  month    pnl  n win%   pf
2023-08 -385.0 26 23.1 0.27
2023-09  -61.6 34 29.4 0.89
2023-10    5.7 26 30.8 1.01
2023-11   17.9 30 36.7 1.05
2023-12 -198.4 14 14.3 0.23
```


### 3) 亏损交易形态（启发式分类）

分类逻辑：

- `chop_stop`：入场后<=60min 止损，且入场前 20 根(5m)区间/ATR <= 1.8（更像横盘反复打止损）

- `chase_stop`：入场后<=60min 止损，且入场前 20 根(5m)区间/ATR >= 3.0（更像追击趋势末端）

- `slow_bleed`：持仓>180min 后仍止损（更像钝刀子割肉）

```
 loss_mode  n     pnl    avg_pnl  median_hold_min
chase_stop 49 -1003.0 -20.469388             14.0
slow_bleed 32  -889.4 -27.794643            606.5
      stop  8  -174.0 -21.750000            124.5
 fast_stop  3   -65.0 -21.666667              3.0
       win 38  1510.0  39.736842            684.5
```


### 4) 聚焦 2B：为什么在 P2401 上亏损

- 2B 笔数：41

- 2B 总PnL：-478


2B 的信号统计：

```
signal_type  n    pnl win%   avg avg_win avg_loss   pf payoff
         2B 41 -478.0 22.0 -11.7    26.8    -23.2 0.34   1.16
```


2B 的月度分布：

```
  month    pnl  n win%   pf
2023-08 -100.0  4  0.0 0.00
2023-09  -58.9 14 35.7 0.74
2023-10 -108.7  6 16.7 0.02
2023-11 -150.3 11 18.2 0.25
2023-12  -60.1  6 16.7 0.29
```


2B 最差交易（按PnL升序）：

```
         entry_time           exit_time  direction   pnl holding_min  loss_mode    ctx_sig_bar_time ctx_macd15_gap ctx_ma60_slope ctx_ret_20 ctx_range_20_atr
2023-11-01 22:16:00 2023-11-02 09:00:00          1 -72.0     644.000 slow_bleed 2023-11-01 22:15:00          4.709          1.233      0.003            3.059
2023-10-23 22:01:00 2023-10-24 09:00:00          1 -58.0     659.000 slow_bleed 2023-10-23 22:00:00          2.428         -5.933      0.001            3.833
2023-08-29 10:11:00 2023-08-29 14:51:00          1 -47.0     280.000 slow_bleed 2023-08-29 10:10:00          7.648          0.800      0.005            3.285
2023-09-20 09:11:00 2023-09-20 10:51:00          1 -39.0     100.000       stop 2023-09-20 09:10:00          6.086          4.167     -0.001            5.216
2023-11-07 13:41:00 2023-11-07 14:20:00          1 -39.0      39.000 chase_stop 2023-11-07 13:40:00          4.841          4.567      0.007            4.877
2023-09-22 10:38:00 2023-09-22 13:40:00          1 -31.0     182.000 slow_bleed 2023-09-21 22:55:00          4.725         -4.200      0.003            4.154
2023-09-12 10:11:00 2023-09-12 11:08:00          1 -31.0      57.000  fast_stop 2023-09-12 10:10:00          8.655        -15.233      0.005            2.697
2023-09-05 09:01:00 2023-09-05 09:45:00          1 -31.0      44.000 chase_stop 2023-09-05 09:00:00          4.798         -3.600      0.002            4.000
2023-09-25 09:26:00 2023-09-25 09:43:00          1 -29.0      17.000 chase_stop 2023-09-25 09:25:00          4.162          4.267      0.005            3.674
2023-11-28 10:41:00 2023-11-28 10:51:00          1 -29.0      10.000 chase_stop 2023-11-28 10:40:00          1.713         10.333      0.004            4.094
2023-11-17 14:31:00 2023-11-17 21:15:00          1 -25.0     404.000 slow_bleed 2023-11-17 14:30:00          6.275         -7.233      0.002            2.771
2023-08-25 10:31:00 2023-08-25 10:36:00          1 -25.0       5.000 chase_stop 2023-08-25 10:30:00          6.085          1.267      0.007            4.865
2023-12-04 09:06:00 2023-12-04 09:14:00          1 -25.0       8.000 chase_stop 2023-12-04 09:05:00         10.318          0.700     -0.001            4.110
2023-09-27 09:56:00 2023-09-27 10:55:00          1 -23.0      59.000 chase_stop 2023-09-27 09:55:00          4.245          0.733      0.006            5.250
2023-10-20 14:56:00 2023-10-20 21:35:00          1 -21.0     399.000 slow_bleed 2023-10-20 14:55:00          6.401         -7.267      0.001            4.038
```


**读表提示**：

- `ctx_macd15_gap`：15m (diff-dea) 强度，越接近0越弱

- `ctx_ma60_slope`：5m MA60 斜率代理（>0偏多，<0偏空）

- `ctx_range_20_atr`：入场前20根(5m)的价格区间 / ATR，越大说明入场前已走出较大波段


---

## P2601 深度诊断：bi_gap 敏感性

逐笔导出：gap4=`iter5_P2601_trades_gap4.csv`, gap7=`iter5_P2601_trades_gap7.csv`


- gap4: trades=127, pnl=1477

- gap7: trades=88, pnl=-130


### 1) 信号类型统计对比

#### gap4

```
signal_type  n    pnl win%  avg avg_win avg_loss   pf payoff
         3S 26  -38.1 34.6 -1.5    30.7    -18.5 0.88   1.66
         2S 41  155.6 31.7  3.8    59.5    -22.1 1.25   2.70
         3B 25  251.0 56.0 10.0    33.3    -19.6 2.16   1.70
         2B 35 1109.0 45.7 31.7    93.3    -20.2 3.89   4.62
```

#### gap7

```
signal_type  n    pnl win%  avg avg_win avg_loss   pf payoff
         3B 13 -110.4 23.1 -8.5    22.5    -17.8 0.38   1.27
         3S 12  -38.4 33.3 -3.2    39.6    -24.6 0.80   1.61
         2S 38   -3.3 36.8 -0.1    37.3    -21.9 0.99   1.70
         2B 25   22.6 28.0  0.9    68.4    -25.3 1.05   2.70
```


### 2) gap7 砍掉了哪些交易？（以 gap4 为基准）

信号数量变化（按 signal_type）：

```
signal_type  gap4_n  gap7_n  drop_n
         3S      26      12      14
         3B      25      13      12
         2B      35      25      10
         2S      41      38       3
```


按 信号确认时间`ctx_sig_bar_time`（若无则退回entry_time，容忍±30min） + direction(+优先信号类型) 匹配，gap4 中缺失于 gap7 的交易：

- missing_n=106

- missing_pnl=1106

- missing_win%=39.6%

- missing_PF=1.89


**被砍掉的交易中，贡献最大的 Top20（如果这些是好交易，被砍会导致 PnL 断崖）**：

```
         entry_time           exit_time  direction signal_type   pnl holding_min loss_mode    ctx_sig_bar_time ctx_macd15_gap ctx_ma60_slope ctx_ret_20 ctx_range_20_atr
2025-08-11 11:21:00 2025-08-12 21:01:00          1          2B 348.0    2020.000       win 2025-08-11 11:20:00          2.579         -1.900      0.005            4.474
2025-08-15 13:31:00 2025-08-18 09:01:00          1          2B 224.6    4050.000       win 2025-08-15 11:30:00          4.880          2.000      0.003            3.322
2025-10-28 13:56:00 2025-10-29 09:38:00         -1          2S 188.1    1182.000       win 2025-10-28 13:55:00         -3.095         -9.167     -0.002            3.794
2025-09-09 13:56:00 2025-09-10 09:56:00         -1          2S 165.1    1200.000       win 2025-09-09 13:55:00         -1.195          5.900     -0.001            4.586
2025-07-07 13:51:00 2025-07-08 15:00:00          1          2B 148.9    1509.000       win 2025-07-07 13:50:00          2.787          0.367      0.002            4.511
2025-07-17 10:46:00 2025-07-18 10:02:00          1          2B 148.3    1396.000       win 2025-07-17 10:45:00          0.994          1.167      0.003            4.822
2025-07-02 10:06:00 2025-07-03 09:13:00          1          3B 110.9    1387.000       win 2025-07-02 10:05:00          2.244          4.100      0.002            5.158
2025-09-15 09:06:00 2025-09-15 22:45:00          1          2B 100.6     819.000       win 2025-09-15 09:05:00          2.755         -5.733      0.004            4.667
2025-10-31 14:26:00 2025-11-03 09:07:00         -1          2S  93.3    4001.000       win 2025-10-31 14:25:00         -5.488         -3.800     -0.000            4.567
2025-07-11 09:29:00 2025-07-11 11:10:00          1          2B  87.7     101.000       win 2025-07-11 09:05:00          0.791          3.167      0.004            5.521
2025-08-22 22:06:00 2025-08-25 10:52:00          1          2B  65.1    3646.000       win 2025-08-22 22:05:00          5.459         -0.800      0.004            5.712
2025-09-05 09:56:00 2025-09-05 21:01:00          1          2B  64.4     665.000       win 2025-09-05 09:55:00          0.838          2.467      0.004            3.881
2025-07-15 09:56:00 2025-07-15 22:35:00         -1          2S  63.3     759.000       win 2025-07-15 09:55:00         -1.706          7.000      0.000            3.618
2025-09-24 22:01:00 2025-09-25 09:06:00          1          3B  48.1     665.000       win 2025-09-24 22:00:00         15.663          7.367      0.004            5.739
2025-07-18 21:24:00 2025-07-21 09:01:00          1          3B  40.0    3577.000       win 2025-07-18 10:15:00          8.232         12.067      0.006            5.960
2025-09-18 09:06:00 2025-09-18 11:19:00         -1          3S  36.0     133.000       win 2025-09-18 09:05:00         -6.500        -13.000     -0.006            5.019
2025-07-30 21:06:00 2025-07-31 11:02:00         -1          2S  35.9     836.000       win 2025-07-30 21:05:00         -4.190         -0.333     -0.003            4.554
2025-07-23 10:01:00 2025-07-23 13:45:00          1          2B  32.7     224.000       win 2025-07-23 10:00:00          6.084         -0.500      0.002            3.920
2025-09-11 22:56:00 2025-09-12 10:36:00          1          3B  32.0     700.000       win 2025-09-11 22:55:00          7.896          7.767      0.004            5.075
2025-07-29 14:46:00 2025-07-30 09:10:00          1          3B  31.3    1104.000       win 2025-07-29 14:45:00         12.053          2.733      0.011            8.346
```


---

## 失败模式总结（数据驱动）

### P2401

- 亏损贡献最大的信号类型：2B（pnl=-478, n=41）

- 盈利贡献最大的信号类型：2S（pnl=175, n=38）

- 亏损模式占比（看 `loss_mode` 的n）：chop_stop vs chase_stop 的相对规模，能回答“震荡反复止损”还是“追趋势末端”更严重。


### P2601

- bi_gap 从 4→7 的核心影响不是单纯减少交易数，而是**减少了哪些类型的交易**、以及这些交易的净贡献（见 missing_pnl 和 Top missing 表）。


## 对策建议（可落地、以本诊断结果为依据）

1) **针对 P2401：给 2B 加一条“弱势禁止”过滤（先验证再上强逻辑）**

   - 如果 `2B` 的亏损集中在 `ctx_macd15_gap` 接近0 或 `ctx_ma60_slope<0` 的样本，说明 2B 在弱多/大级别下跌中抄底。

   - 建议先做最小改动：仅对 `2B` 要求 `ctx_macd15_gap` 大于某个分位数阈值，或要求 `ma60_slope>0`（仅用于 P2401/或对 2B 全局）。

2) **针对 P2401：分场景处理 chase_stop vs chop_stop**

   - 若 `chop_stop` 占比高：说明震荡区间反复打止损 → 考虑提高 entry_filter_atr / 加入“最近20根 range_20_atr 过小则不做”（横盘过滤）。

   - 若 `chase_stop` 占比高：说明追击末端 → 对 2B/3B 增加“入场前 range_20_atr 过大则不追”的反追击过滤。

3) **针对 P2601：不要用统一 bi_gap 砍交易；改为“动态 bi_gap / 或只对某类信号放宽”**

   - 如果 Top missing 里多数是 `3B/3S`（或某一类），说明 bi_gap=7 主要砍掉的是该类的好交易。

   - 可尝试：3B/3S 保持低 bi_gap（如4），2B/2S 提高 bi_gap（如7）来减少噪声，同时保住趋势腿。

4) **验证路径**

   - 先做单一改动（例如：仅对 2B 加 `ma60_slope>0`），重跑 7合约。

   - 用本脚本同样方式对比“被过滤掉的交易”是否主要是坏交易（missing_pnl 变负/或 Top missing 消失）。
