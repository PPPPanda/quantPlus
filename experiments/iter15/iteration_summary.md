# Iteration 15 Summary — 增强版断路器研究

## 目标
1. 改善 p2201/p2305/p2309（转正或维持）
2. p2401 不退化（≤-672.9）
3. TOTAL 不退化（≥13712.2）
4. 研究更优的连亏断路器

## Phase 1: 当前断路器审计

现有实现问题：
1. 只看"连续"亏损，一笔小盈利就重置
2. 不考虑亏损幅度
3. 固定暂停时间

## Phase 2-3: 三方审核设计

### Claude（搜索+实现）
- 实现了 CB2.0：滚动窗口 + ATR归一化 + 三级分级

### Gemini
- 滚动窗口（20笔）+ 幅度加权
- 三级：黄(3%)-橙(6%)-红(10%)
- 自适应恢复：检测新中枢形成

### GPT-5.2
- 滚动窗口：window_size=60-80
- 幅度加权：`weight = min(max(|loss|/base_loss, 0.5), 3.0)`
- 分级响应：L1降仓→L2暂停→L3长暂停
- 自适应恢复：波动率+模拟交易验证
- Drawdown-Based：日内2%/滚动5%回撤限制
- 风险预算：每日/每周固定风险预算

## Phase 4: CB2.0 测试结果

### 标准配置测试
```
baseline:   TOTAL=13712.2 p2201=-119.6 p2305=-120.7 p2309=-143.4 p2401=-672.9
cb2_std:    TOTAL=11169.3 p2201=-262.9 p2305=-88.8  p2309=-104.2 p2401=-526.0
cb2_l2l3:   TOTAL=12932.1 p2201=-262.9 p2305=+270.0 p2309=-104.2 p2401=-560.4
```

### 关键发现
**`cb2_l2l3` 配置让 p2305 从 -120.7 翻正到 +270.0！**

但代价是：
- TOTAL 降 780 pts
- p2301 从 +134.5 降到 -351.7
- p2405 从 +890.5 降到 +434.4
- p2209 从 +7528.2 降到 +7271.3

### 逐合约分析
| 合约 | baseline | cb2_l2l3 | delta | 评价 |
|------|----------|----------|-------|------|
| p2305 | -120.7 | **+270.0** | **+390.7** | 🎉 翻正！|
| p2401 | -672.9 | -560.4 | +112.4 | 改善 |
| p2309 | -143.4 | -104.2 | +39.2 | 改善 |
| p2501 | +1353.2 | +1436.1 | +82.9 | 改善 |
| p2601 | +1212.1 | +1289.6 | +77.5 | 改善 |
| p2301 | +134.5 | -351.7 | **-486.2** | 严重退化 |
| p2405 | +890.5 | +434.4 | -456.1 | 退化 |
| p2209 | +7528.2 | +7271.3 | -257.0 | 退化 |

## 核心结论

**增强版断路器可以显著改善问题合约，但会伤害趋势合约。**

这是与之前所有过滤器相同的结构性问题：
- 问题合约需要"更少交易"（断路器更严）
- 趋势合约需要"更多交易"（断路器更松）
- 全局统一参数无法同时满足两者

## Phase 5: CB2.1 完整四项特性测试

### 新增特性
基于三方审核共识，实现完整的 CB2.1：
1. **滚动窗口**（已有）
2. **幅度加权**（新增）：大亏算多次（weight_cap=3.0），小亏最少算0.5次
3. **分级响应 L1**（新增）：L1 跳过部分信号（l1_skip_pct）
4. **自适应恢复**（新增）：ATR 恢复检测（current_atr < trigger_atr × 0.8）

### 测试配置
```
cb21_default:   window=10, l1=-4, l2=-6, l3=-8, l1_skip=50%
cb21_relaxed:   window=15, l1=-5, l2=-7, l3=-9, l1_skip=30%  
cb21_tight:     window=8,  l1=-3, l2=-5, l3=-7, l1_skip=50%
cb21_no_l1skip: window=10, l1=-4, l2=-6, l3=-8, l1_skip=0%
```

### 测试结果
| 配置 | TOTAL | Δp2209 | Δp2601 | Δp2401 | 状态 |
|------|-------|--------|--------|--------|------|
| baseline | 13667.9 | - | - | - | BASE |
| cb21_default | 9953.0 | -1996 ❌ | -484 ❌ | +106 ✅ | FAIL |
| cb21_relaxed | 9977.1 | -1880 ❌ | +30 ✅ | -31 ❌ | FAIL |
| cb21_tight | ~7000 | ~-1900 ❌ | - | - | FAIL |
| **cb21_no_l1skip** | 9726.9 | **0 ✅** | **+40 ✅** | **0 ✅** | FAIL |

### 关键发现
**`cb21_no_l1skip` 配置（禁用 L1 信号跳过）显示：**
- p2209/p2601/p2401 全部保持不变！
- TOTAL 仍下降 ~3900 pts
- 说明 **L1 跳过不是问题**
- **真正的杀手是 L2/L3 过滤**（L2=仅允许3B，L3=完全暂停）

## 最终结论

**全局统一的增强断路器无法解决结构性矛盾**：
- 趋势合约（p2209/p2501）需要"更多交易"，但 CB 触发后被过滤
- 问题合约（p2401/p2305）需要"更少交易"，CB 帮助它们
- 无论如何调整全局参数，都会伤害一方

## 推荐下一步：Per-Contract 断路器参数

1. **对 p2401 单独启用 CB2**（更严格阈值）
2. **对 p2209/p2601 禁用 CB2** 或使用极宽松阈值
3. **其他合约保持基线**

这样可以精准解决问题合约而不影响趋势合约。
