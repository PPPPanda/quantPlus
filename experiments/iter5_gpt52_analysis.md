# iter5 · Phase 1 v2（缠论结构审计）+ Phase 3 v2（修复方案设计）

> 对象：`cta_chan_pivot.py`（增量5m/15m，包含→分型→严格笔→滑动中枢→3B/3S/2B/2S，15m MACD过滤，ATR止损/移动止损）
>
> 背景输入：
> - baseline Phase1 审计：中枢滑动窗口导致 80%+重叠、寿命仅1笔；2B/2S“背驰”方向反；笔/中枢均缺少状态机/事件序列。
> - 4轮迭代：严格修正缠论（中枢状态机+真背驰）PnL 暴跌；bi_gap 与合约间“信号密度需求”矛盾；笔幅度过滤可把7合约全拉正但信号太少；P2401几乎一直负。

---

## Phase 1 v2：重新审计（基于4轮迭代新发现）

### 0. 代码现状速描（关键实现点）

1) **笔**：`_process_bi()`
- 包含处理后的K线上，用三根结构判顶/底（mid相对左右）形成候选点。
- “严格笔”仅约束 `cand.idx - last.idx >= min_bi_gap`（默认4）。
- 无“笔确认/未确认”状态机；同向点只做延伸。

2) **中枢**：`_update_pivots()`
- 最近4个笔端点（3笔）求交集：`zg=min(三个高)`，`zd=max(三个低)`，`zg>zd` 则立刻 append 新pivot。
- 无“中枢延伸/扩展/升级/离开/确认”状态机；**每来一笔都可能生成新中枢**。

3) **信号**：`_check_signal()`
- 15m MACD 方向：`is_bull = prev_diff_15m > prev_dea_15m`；`is_bear` 类似。
- 3B：回踩底点 `p_now.bottom` 且 `p_now.price > last_pivot.zg`，并且离开段端点 `p_last.price > zg`，且 pivot “足够新”（`end_bi_idx >= len(bi_points)-pivot_valid_range`）
- 3S：对称逻辑。
- 2B/2S（标注背驰）其实用的是：
  - 2B：`p_now.price > p_prev.price` 且 `p_now.diff > p_prev.diff`（动能更强）
  - 2S：`p_now.price < p_prev.price` 且 `p_now.diff < p_prev.diff`
  这更接近“趋势加速/动量延续”，不是缠论背驰。

4) **入场**：延迟触发（1m级别突破 trigger 才开仓）；止损基于 `stop_base±1`；
- **没有任何出场事件序列**，几乎完全依赖：硬止损 + ATR移动止损。

---

## 1) 为什么“修正缠论偏差”反而让策略变差？原版“非标实现”到底利用了什么市场特性？

### 1.1 现象回顾（来自迭代总结）
- 直接修正（中枢状态机 + 真背驰）→ 总PnL 暴跌 88%。
- 说明：原版的优势并不来自“缠论定义正确”，而来自**某种可交易的统计结构**被非标实现放大。

### 1.2 代码层面的“非标优势”拆解

**(A) 滑动中枢 = 把“中枢”当作动态区间锚（近似：自适应箱体/噪声带）**
- `_update_pivots()` 每来一笔就可能新生成 pivot，且 `last_pivot` 永远指向最新。
- 这等价于：用一个“非常短记忆”的区间（由最近3笔重叠区）来定义“当前市场均衡带”。
- 对于**高均值回归/高换手震荡**的合约阶段，这类短记忆区间会快速贴合价格→
  - 3B/3S 的“>ZG / <ZD”条件会频繁在边界附近出现，形成“反复试探后的小波段”捕捉。

**(B) 2B/2S 名义背驰、实为动量延续：在趋势型阶段帮P2509/P2601“追随”**
- 迭代结果显示：P2509/P2601 的盈利主力来自 2B/2S（尤其2B）。
- 原因：2B/2S 的判断是“更高低点 + 更强diff/更弱diff”，本质是**确认趋势正在加速**。
- 真背驰会在趋势延续里经常给出“反向/减弱”信号，削弱趋势吃肉；因此修正后反而伤害。

**(C) 缺少出场结构 = 让盈利分布更像‘小赢多次+少数大亏由止损截断’**
- 原版靠频繁信号，配合较紧的结构止损（`stop_base±1`）和ATR移动止损，
- 在震荡里更像“打点吃回撤/吃反弹”的交易风格：
  - 正确的中枢状态机会减少伪中枢 → 信号变少 → 震荡里“吃小波段”的机会被砍掉。

**结论**：
- “非标实现”的核心可交易性并非缠论严格定义，而是：
  1) **短记忆动态箱体（滑动中枢）**捕捉震荡回归；
  2) **动量型2B/2S**捕捉趋势延续；
  3) 缺乏结构化出场，让策略依赖“信号频率+止损”塑造收益分布。

---

## 2) 为什么“中枢滑动窗口”产生的频繁中枢切换对 P2509/P2601 的 2B 信号有利？

### 2.1 观察：P2509/P2601 主要靠 2B/2S 赚钱
BEST参数下：
- P2509：2B +1130（49笔），2S +576（58笔）
- P2601：2B +1109（35笔），2S +156（41笔）

### 2.2 机制：滑动中枢为“动量入场”提供了更快的上下文更新
- 当行情进入趋势推进（尤其是“推进-回撤-再推进”的阶梯结构），最近3笔的重叠区会不断上移/下移。
- 2B/2S 逻辑并不依赖中枢，但滑动pivot造成：
  - **3B/3S 更难形成长期有效的锚**（因为锚不断变化）→ 反而让系统更依赖2B/2S；
  - 同时，pivot_valid_range 只要求最近pivot够新，这在趋势中几乎总成立。
- 换言之：在 P2509/P2601 的“趋势更干净、推进更连续”阶段，
  滑动pivot并不会造成太多错误锚定，反而减少“长中枢把趋势当震荡”的误判，
  使得 2B/2S（动量）成为主导并持续生效。

### 2.3 反面：对震荡/假突破更频繁的合约（如P2201/P2401）则会制造噪声
- P2201：2B 是正，但 3B/3S/2S 多为负（结构锚不断变，使突破/回踩判定漂移）。
- P2401：2B 显著为负，说明其“动量加速”型入场在该合约更容易买在衰竭/假趋势里。

---

## 3) bi_gap 与笔幅度的关系：为什么幅度过滤能让所有合约转正但幅度太大？

### 3.1 本质：bi_gap 和 bi_amp_filter 都在调“结构分辨率/信号密度”
- `min_bi_gap` 增大：减少笔端点数量 → 中枢/信号都减少；同时每笔更“粗”。
- `bi_amp_filter`（实验中加入的“笔幅度>=xATR”）增大：减少小波动笔 → 等价于在“价格维度”加粗结构。

两者共同作用是：**把市场微结构噪声排除掉**。

### 3.2 为什么能“全转正”？
- 7合约共同的亏损来源之一是：
  - 由包含+三K分型在噪声里产生大量端点 → 滑动pivot寿命=1笔 → 3B/3S 锚飘 → 假突破/假回踩。
- 幅度过滤砍掉了大量“噪声笔”，相当于降低 pivot 切换频率、提升 pivot 稳定性，
  使 3B/3S 的“>ZG/<ZD”更接近有效结构，止损更少被打穿。

### 3.3 为什么幅度“一大就不够800”？
- 过滤过强后：
  - 交易次数骤降 → 机会成本上升；
  - 2B/2S（动量）也被砍掉（因为趋势推进中的回撤笔可能幅度不够ATR阈值）；
  - 对 P2601/P2509 这类“靠2B/2S堆收益”的合约，收益弹性依赖足够的信号密度。
- 因此出现“全正但总收益不足”的典型现象：胜率/期望改善，但样本数过少。

**结构结论**：需要的是“自适应/情景化的分辨率”，而不是单一固定的高阈值。

---

## 4) P2401 为什么在几乎所有配置下都是负收益？（从缠论结构角度）

### 4.1 直接证据：BEST参数下 P2401 的亏损结构
- 总PnL -621
- 信号分解：
  - 3B -41（23笔）近乎持平
  - 3S -277（28笔）显著亏
  - 2B -478（41笔）最大亏损来源
  - 2S +175（38笔）反而是正

这说明：
- P2401 的“动量型做多（2B）”在该合约更容易失败；
- 而做空侧的 2S 居然赚钱，暗示其更可能处在：
  - 长期偏弱/下跌推进更顺畅；
  - 或反弹结构更像“弱反弹”，适合顺势做空。

### 4.2 结构解释：P2401 更像“弱趋势 + 高频假反弹”的组合
结合策略结构：
- 2B 需要 `is_bull`（15m diff>dea）才触发，但 15m MACD 在弱趋势/震荡下容易频繁翻转，
  造成**在总体偏弱的大结构中出现一段短暂MACD转多** → 触发大量2B追多。
- 同时策略没有“走势类型/线段/大级别中枢位置”过滤，导致：
  - 在大级别下跌的反弹段里，低级别经常呈现“更高低点+diff更强”（短促反弹加速），
  - 这恰好满足 2B 的动量条件，但随后很容易被主跌趋势吞没 → 2B系统性亏损。

### 4.3 关键矛盾：修正为真背驰虽更缠论，但可能进一步降低P2509/P2601盈利
- P2401需要“避免在弱反弹里追多”的过滤；
- 但 P2509/P2601 需要保持足够的动量入场。

因此解决方向应是：**在不抹掉动量模块的前提下，增加‘识别弱反弹/假趋势’的上下文判别**，而非把2B彻底改成背驰。

---

# Phase 3 v2：全新修复方案设计（至少5个，且不重复已试过方案）

> 禁止重复已试：
> - 禁用3S短（已试过）
> - 笔幅度过滤（已试过）
> - MACD一致性（已试过）
> - ADX、波动率过滤（已试过）
> - pivot宽度、冷却、利润目标（已试过）
>
> 下述方案避免上述“直接同类参数化过滤”，改为**结构/机制级**改动：
> - 重点：提升 P2201/P2401，同时尽量不伤 P2509/P2601。

---

## 方案1：基于“中枢重叠率”的**震荡/趋势双模交易**（Regime switch，不靠ADX/波动率）

- **失败模式**：
  - P2401 在弱趋势反弹中触发大量 2B 追多 → 系统性亏损；
  - P2201 在噪声震荡中 3B/3S 锚漂移 → 假突破频繁。

- **目标**：
  - 保留 P2509/P2601 的 2B/2S 动量收益；
  - 对“高重叠中枢（箱体震荡）”阶段，减少动量追击，改为区间回归型入场/出场。

- **方案（缠论/量化依据）**：
  - Phase1 已证实：连续中枢重叠率 80%+，中枢寿命仅1笔。
  - 重叠率高代表：最近结构一直在一个“共同重叠区”内来回，属于**中枢震荡特征**。
  - 量化上可用最近N个pivot的交叠程度衡量“箱体粘连”。

- **具体代码改动（建议实现点）**：
  1) 新增函数 `_calc_pivot_overlap_score(M=8)`：
     - 取最近M个pivot，计算它们两两是否重叠（`min(zg) > max(zd)`）或与滚动交集区的重叠比例；
     - 得到 `overlap_score ∈ [0,1]`。
  2) 在 `_check_signal()` 前置判断：
     - `if overlap_score > 0.7: regime='range' else: regime='trend'`
  3) **range 模式**：
     - 禁止 2B/2S 动量入场（或只允许 2S，视方向）；
     - 引入“中枢边界回归”信号（全新，不是profit target）：
       - 当价格触及/跌破 `last_pivot.zd` 后快速收回（例如1-2根5m收回到zd上方），做多；
       - 当价格触及/突破 `last_pivot.zg` 后回落到zg下方，做空；
       - 止损：结构外侧（zd下/zg上）的小缓冲。
  4) **trend 模式**：
     - 维持现有 2B/2S（动量）作为主力；
     - 3B/3S 保留或弱化。

- **预期效果**：
  - P2401：大量亏损的 2B 追多在高重叠震荡/弱反弹阶段被抑制；
  - P2201：在“箱体粘连”里用边界回归替代假突破追击；
  - P2601/P2509：在趋势段 overlap_score 较低，依旧主要做 2B/2S，不会被整体阉割。

- **风险**：
  - overlap_score阈值选择不当可能误判趋势为震荡；
  - 新的回归信号需要严格定义“触及后收回”，否则会增加抄底摸顶风险。

---

## 方案2：在线“重叠中枢合成”为**锚定中枢（Anchored Pivot Stack）**，保留滑动但稳定参照

- **失败模式**：
  - 滑动中枢每笔更新导致 last_pivot 漂移，3B/3S 的 ZG/ZD 参照不稳定（尤其P2201/P2401）。
  - 但完全上状态机（严格缠论）已验证会伤总PnL。

- **目标**：
  - 不引入完整缠论状态机（避免“修正反而变差”），
  - 但降低“伪中枢漂移”对3B/3S与风控锚定的破坏。

- **方案（依据）**：
  - 审计报告：80%+连续中枢互相重叠；合并后中枢数缩减75-80%。
  - 说明大量pivot本质属于同一更大中枢（市场在同一均衡区）。
  - 不必重写状态机，只需把最后的“有效锚”变成：最近一串重叠pivot的并集/交集。

- **具体代码改动**：
  1) 新增 `self._pivot_stack: list[dict]` 或在 `_pivots` 上做后处理。
  2) 每次 `_update_pivots()` append 后：
     - 从尾部回溯，把与最新pivot重叠的若干pivot合并为一个 `anchor_pivot`：
       - 合并方式1（更稳）：取交集：`zg=min(zg_i)`, `zd=max(zd_i)`（更窄、但更“共同区域”）
       - 合并方式2（更宽）：取并集：`zg=max(zg_i)`, `zd=min(zd_i)`（更宽，适合震荡）
     - 将 `anchor_pivot` 作为信号锚（`last_pivot = anchor_pivot`），而不是最新的单pivot。
  3) `pivot_valid_range` 仍保留，但针对 anchor_pivot 的 end_bi_idx。

- **预期效果**：
  - P2201/P2401：3B/3S锚不再每笔漂移，假突破/假回踩减少；
  - P2509/P2601：趋势段中枢重叠本来就少，anchor_pivot≈last_pivot，影响较小。

- **风险**：
  - 交集合并可能过窄导致信号减少；并集合并可能过宽导致过早认为“在中枢内”；
  - 需在debug里输出 anchor_pivot 变化，防止异常粘连。

---

## 方案3：引入“离开-回抽-失败（假突破）”的**2类失败结构交易**（专打P2201/P2401的假趋势）

- **失败模式**：
  - P2201/P2401 高频假突破：价格短暂离开 pivot 边界后迅速回到中枢，
    原策略容易在触发价突破时进场，随后被回撤打止损。

- **目标**：
  - 把“假突破回归”从噪声变成可交易结构；
  - 同时不削弱 P2509/P2601 的趋势推进（真突破）。

- **方案（依据）**：
  - 缠论里“离开中枢后的回拉不回中枢”才是买卖点核心；
  - 量化上，假突破最常见形态是“突破后N根内重新进入区间”。

- **具体代码改动**：
  1) 在 `_check_signal()` 中，对 last_pivot 增加一类 **Failure-2B/F2S**（命名自定义）：
     - 多头假突破：
       - 条件：出现 `p_last` 离开（高于zg），但随后 `p_now.bottom` 回踩**跌回到zg以下**，且接下来1-2根5m收回到zg上；
       - 入场：收回确认时做多（相当于“假突破洗盘后再上”）；
     - 空头假突破对称。
  2) 需要在 `self._pending_signal` 中记录“确认窗口截止时间/计数”，避免无限等待。

- **预期效果**：
  - 对 P2201/P2401：把最常见的亏损来源（假突破）变为“等待收回确认再入场”，大幅减少追高/追低；
  - 对 P2509/P2601：真趋势突破通常不会很快回到区间内，因此不会触发该类信号，趋势交易不受影响。

- **风险**：
  - 若市场进入单边快速反转，该信号可能把反转当洗盘；
  - 需配合更紧的结构止损（中枢内/外侧）避免大回撤。

---

## 方案4：全新“出场结构”：**中枢回归/反向分型出场 + 时间止盈止损（Time stop）**

- **失败模式**：
  - 当前几乎只有止损/ATR移动止损：
    - 在震荡中容易“盈利没锁住 → 回撤被打到很小甚至止损”；
    - 在弱趋势里持仓时间过长，成本升高。

- **目标**：
  - 不使用固定利润目标（已试过），改用结构化出场：
    - 震荡：回到中枢内就减仓/平仓；
    - 趋势：出现反向分型/新笔确认就退出部分；
    - 时间维度：若N根5m未形成新高/新低或未走出X ATR，则平仓。

- **方案（依据）**：
  - 缠论买卖点不是只看入场，更强调“离开/回拉/再离开”的节奏。
  - 量化上，很多亏损来自“持仓后无进展”的漂移。

- **具体代码改动**：
  1) 新增持仓计数器 `self._hold_bars_5m`，在 `_on_5m_bar()` 每根递增。
  2) 在 `_on_5m_bar()` 的持仓管理里加入：
     - **回归中枢出场**：
       - 多头：若 close < anchor_pivot.zg（或进入[zd,zg]区间）则先平一半或全平；
       - 空头对称。
     - **反向分型/新笔出场**：
       - 当形成与持仓方向相反的新笔端点（例如持多出现新top后又出现更低top/或出现确认下行笔），触发退出。
     - **时间止损/止盈**：
       - 若 `self._hold_bars_5m > N` 且浮盈<0 或浮盈<某个很小阈值（可用`0.5*ATR`等相对值），则退出。

- **预期效果**：
  - P2201/P2401：震荡里不再把利润吐回去；无效交易更快退出降低回撤；
  - P2509/P2601：趋势持仓仍可通过ATR移动止损吃大段，但在趋势失败时能更快离场。

- **风险**：
  - 过早出场可能削弱趋势段收益；
  - “半仓/全仓”涉及仓位管理，需确认CTA引擎支持部分平仓逻辑且回测一致。

---

## 方案5：用“结构密度（bi density）”替代 bi_gap/幅度过滤：**自适应抑噪，不减少趋势信号**

- **失败模式**：
  - 固定 `min_bi_gap` 无法兼容：P2201需要更稀疏结构，P2601需要更密集信号。
  - 固定幅度过滤也有同类矛盾：统一阈值会把趋势推进中的有效回撤笔过滤掉。

- **目标**：
  - 在同一参数集下，让策略自动判断“现在结构是不是太密（噪声）”，
    在噪声时提高确认门槛、在趋势时降低门槛。

- **方案（依据）**：
  - 不用外部指标（ADX/波动率已试），直接用策略内部产物：
    - `k_lines_count / bi_count` 反映平均每笔需要多少根包含后K线（结构分辨率）。
  - 噪声期：bi_count增长快 → 密度高；趋势期：笔更长 → 密度低。

- **具体代码改动**：
  1) 新增 `_calc_bi_density(window_k=200)`：
     - 统计最近window_k根包含后K线内新增了多少笔端点/成笔数，得到 `density`。
  2) 在 `_check_signal()` 中动态调整“确认要求”，而不是改min_bi_gap：
     - 当 density 高（噪声）：
       - 仅允许“收盘价确认”触发（例如 1m触发改为必须 5m close 突破 trigger），或要求突破幅度达到 `0.3*ATR`（小阈值，非幅度过滤笔本身）；
     - 当 density 低（趋势）：
       - 维持原先 1m突破触发（更灵敏，保住P2601/P2509）。

- **预期效果**：
  - P2201/P2401：噪声期减少“刚刺破就回撤”的触发；
  - P2509/P2601：趋势期仍允许高频捕捉推进。

- **风险**：
  - density阈值需要用历史分位数/自适应标准化，否则不同合约绝对值不同；
  - 增加触发条件可能导致滑点敏感性上升（由1m触发改5m确认）。

---

## 方案6：引入“量能确认（Volume expansion）”作为突破质量过滤（非ADX/非波动率）

- **失败模式**：
  - P2201/P2401 的假突破往往伴随“量能不支持/冲高回落”，
    但目前策略仅用价格位置+MACD方向，无法区分“真突破/假突破”。

- **目标**：
  - 以交易量作为“离开中枢是否有效”的确认，提高 3B/3S 与动量信号质量；
  - 让趋势合约（P2509/P2601）在放量推进时继续被捕捉。

- **方案（依据）**：
  - 量化常识：突破区间有效性与成交量扩张高度相关；
  - 缠论语境下，“离开中枢”应体现合力，量能是合力的外显。

- **具体代码改动**：
  1) 在5m bar合成中已保留 `volume`（当前`bar_data`未传volume，可补上）：
     - 在 `_on_5m_bar()` 构造 `bar_data` 加入 `volume`。
  2) 维护一个 `deque` 保存最近 `vol_window`（如20）根5m成交量，计算 `vol_ma` 或 `vol_pct`。
  3) 在 `_check_signal()` 生成信号前增加：
     - 若为“离开型信号”（3B/3S 或 2B/2S），要求 `curr_vol > vol_ma * 1.2`（阈值可固定常数，避免新增参数也可写死）
     - 或用分位：`curr_vol > percentile(vols, 70%)`。

- **预期效果**：
  - P2201/P2401：无量假突破被过滤；
  - P2509/P2601：趋势推进阶段通常量能更大，过滤影响较小甚至更聚焦。

- **风险**：
  - 不同合约/不同年份量能结构差异较大（交割前后、交易活跃度变化），分位数法更稳但实现更复杂；
  - 可能在低流动性时段错过机会。

---

# 建议的实施优先级（v2）

1) **方案2（Anchored Pivot Stack）**：改动小，直接针对“锚漂移”，且不等同于完整缠论状态机。
2) **方案1（Overlap Regime Switch）**：把“伪中枢重叠”转为可利用的状态变量，解决P2401追多问题。
3) **方案3（假突破结构）**：专打P2201/P2401的核心亏损形态，且不伤趋势合约。
4) **方案4（结构化出场+时间维度）**：改变收益分布形态，提升低收益合约的累积。
5) **方案5（结构密度自适应触发）**：解决 bi_gap 的跨合约矛盾。
6) **方案6（量能确认）**：作为最后的“质量滤镜”，在不增加太多复杂性的前提下改善假突破。

---

# 给主代理的关键提示（便于下一步实验设计）

- 本轮审计的核心观点是：**不要把策略“修正成缠论”，而是把非标实现背后的统计优势结构化**。
- P2401 的核心亏损来自 2B 追多（动量加速在弱反弹里失效），因此需要“识别弱反弹/假趋势”的上下文，而不是直接否定2B。
- bi_gap/幅度过滤的问题是“单一分辨率无法兼容所有合约”，下一阶段应转向**自适应分辨率（密度/重叠/量能/假突破确认）**。
