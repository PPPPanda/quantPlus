# Phase 3：改动 Backlog（按优先级排序）

> 基于 Phase 1 审计 + Phase 2 诊断，以"最小改动、最大收益"为原则排序。
> 核心策略：**降频 + 过滤空头 + 控制连亏**，不动核心缠论结构。

---

## 优先级 P0：Round 1 实现

### B01: 环境感知空头过滤（3S/2S 条件加强）

**失败模式**：p2405 空头 65 笔净亏 -365；p2601 空头 68 笔仅 +88。
3S 在 p2405 胜率 11%，2S 在 p2405 净亏 -297。

**方案**：
1. 3S 不再直接开空，改为"仅平多头仓位"
2. 2S 增加额外条件：需要 `diff_5m < 0`（5m MACD 在零轴下方）才允许开空
3. 保留在 p2209 这样的下跌趋势中 2S 的有效性

**代码改动点**：`_check_signal()` 中 3S/2S 的 sig 赋值逻辑

**预期影响**：
- p2405: 空头交易大幅减少，PnL 改善 200-300 点
- p2601: 空头减少，小幅改善
- p2209: 2S 仍有效（diff_5m < 0 在下跌趋势中大部分时间成立），影响较小

**风险**：p2209 的空头利润可能小幅下降

---

## 优先级 P1：Round 2 实现

### B02: 连亏冷却机制

**失败模式**：p2209 有 11 连亏（-547 点），p2405 有 7 连亏（-145 点）。

**方案**：
- 连续亏损 ≥ N 笔后，暂停 M 根 5m bar 不开新仓
- 建议 N=3, M=10（约 50 分钟冷却）

**代码改动点**：新增 `_consecutive_losses` 计数器 + `_cooldown_bars` 计时器

**预期影响**：
- 打断连亏螺旋，减少 50-150 点的无效亏损
- 可能错过冷却期内的有效信号（但连亏后大概率是策略与市场不匹配的阶段）

**风险**：冷却期设置不当可能过度限制交易

---

### B03: 止损 buffer 参数化

**失败模式**：±1 硬编码在极端波动时过紧（p2209 ATR 高达 100+ 点时 buffer=1 几乎无效）。

**方案**：
- `stop_buffer = max(pricetick, atr * 0.05)` — 至少一个价格跳动，最多 5% ATR
- 参数化为 `stop_buffer_atr_pct`（默认 0.05）

**代码改动点**：`_open_position()` 中 `stop_base - 1` / `stop_base + 1`

**预期影响**：
- p2209: 减少被极端波动扫止损的次数
- p2601/p2405: 影响微小（ATR 较低时 buffer ≈ 1）

**风险**：buffer 过大会增加单笔亏损额

---

## 优先级 P2：Round 3 实现

### B04: 15m MACD 过滤加强

**失败模式**：当前仅看 diff>dea，在顶部/底部钝化时仍放行错误信号。

**方案**：
- 多头条件加强为：`diff_15m > dea_15m AND diff_15m > 0`（零轴上方金叉）
- 空头条件加强为：`diff_15m < dea_15m AND diff_15m < 0`（零轴下方死叉）

**代码改动点**：`_check_signal()` 中 is_bull / is_bear 的定义

**预期影响**：
- 减少趋势末端的逆势信号
- 可能减少 10-20% 的交易次数

**风险**：过滤过严可能错过趋势初期信号（diff 刚穿越零轴时）

---

### B05: 中枢延伸合并（最小版本）

**失败模式**：中枢数量爆炸（p2601 有 353 个），产生大量无效的"伪中枢"。

**方案**：
- 新中枢 ZG/ZD 区间与上一中枢区间重叠 > 50%：不 append 新中枢，而是延伸上一中枢
- 延伸时更新 end_bi_idx，保持 zg/zd 不变（或取交集）

**代码改动点**：`_update_pivots()` 末尾的 append 逻辑

**预期影响**：
- 减少中枢数量 50-70%
- 3B/3S 信号基于更稳定的中枢，质量提升

**风险**：中改动半径，可能影响信号触发时机

---

## 优先级 P3：Round 4-5 候选

### B06: 最小持仓时长
- 入场后至少持有 N 根 1m bar（如 N=3）才允许止损
- 防止入场后立即被小幅波动扫出

### B07: 2B/2S 背驰逻辑修正
- 将"diff 增强"改为真正的"力度减弱"（MACD 面积比较）
- 高改动半径，谨慎处理

### B08: 信号确认延迟
- 信号生成后等 1 根 5m bar 确认（开盘不破触发价方向）
- 减少假突破
