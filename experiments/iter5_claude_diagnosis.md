# Iteration 5 - Claude 自主诊断结果

## Phase 2: 深度失败模式分析

### P2401 诊断（始终亏损）

**核心问题：Bear 15m 时做多（2B信号）**
- 2B 信号总亏损 -478 点（41笔，胜率仅 22%）
- Bear 15m 时全部交易亏 -547 点（63笔，胜率 22.2%）
- Bull 15m 时反而只亏 -74 点（67笔，胜率 34.3%）
- → 15m MACD 在 P2401 上不够强作为过滤器，Bear 时的 2B 信号在追底

**月度分布**：
- 2023-08 集中亏 -385（26笔中的巨亏月）
- 2023-11 盈亏持平 (-2)
- 整个合约期没有一个月份 > +150

**bi_gap 影响**：
- bg4: -621, bg5: -505, bg7: -474（递减但始终负）
- bg7 过滤掉的 105 笔交易中 76 笔亏损（PnL=-496）→ 过滤有效但不够
- 2B 被过滤 34 笔（PnL=-384）→ 2B 是被过滤掉的主要坏交易

**胜率/盈亏比**：
- 2B: 22% 胜率, avg_win=26.8, avg_loss=-23.2, 盈亏比 1.16 → 不够覆盖低胜率
- 2S: 36.8% 胜率, avg_win=53.3, avg_loss=-23.8 → 唯一正贡献信号
- 3S: 17.9% 胜率 → 几乎全部亏损

### P2601 诊断（bi_gap 敏感）

**核心问题：高 bi_gap 过滤了大量盈利交易**
- bg4: +1477, bg7: -130 → 差 1607 点
- bg7 过滤掉的 106 笔交易总 PnL = **+1253**（好交易！）
  - 2B 贡献 +951（30笔）
  - 3B 贡献 +304（22笔）
  - 2S 贡献 +175（33笔）
  - 3S 贡献 -177（21笔）→ 只有 3S 是坏的

**为什么 P2601 的小笔交易是好交易？**
- P2601 做多在 Bull 15m 时 PnL = +1109（58笔，胜率 50%）
- 做多 avg_win = 93.3（赢的大）
- 这是典型的强趋势合约——频繁的小回调提供低风险入场点

**bi_gap 的结构性伤害**：
- bg4: 35笔2B, 胜率45.7%, avg_win=93.3
- bg7: 25笔2B, 胜率28.0%, avg_win=68.4
- 高 bi_gap 不仅减少了交易数，还降低了胜率和平均盈利

### P2201 诊断

**核心问题：15m MACD 方向与实际走势不一致**
- Bull 15m 时亏 -1037（65笔，胜率 21.5%）→ **很反直觉！**
- Bear 15m 时反而赚 +153（68笔，胜率 30.9%）
- → P2201 的 15m MACD 可能在此周期内给出了系统性错误信号
- SHORT 亏 -641（71笔）> LONG 亏 -244（62笔）→ 空头更差

**假设**：P2201 处于高波动震荡行情，15m MACD 频繁翻转，导致方向判断滞后。
当 15m MACD 显示多头时，价格可能已经到顶（MACD 滞后），反过来也一样。

## Phase 3: 基于诊断的新策略方案

### 方案 1：15m MACD 信号延迟补偿
**失败模式**：15m MACD 在 P2201 上滞后，Bull 时已经到顶
**目标**：减少 MACD 滞后导致的逆势入场
**方案**：
- 不用 15m MACD 的"当前方向"，改用"趋势变化速率"
- 如果 diff_15m - dea_15m 在递减（虽然还是正的），不算 bull
- 即：要求 MACD 不仅为正，而且在加速/持平
**代码改动**：在信号检查时增加 `diff_15m_slope > 0` 的条件
**预期**：改善 P2201（减少滞后追顶），可能影响 P2601
**风险**：可能过滤掉正常回调中的有效信号

### 方案 2：信号类型级别的 bi_gap 分离
**失败模式**：统一 bi_gap 无法同时满足 P2401（需高）和 P2601（需低）
**目标**：让不同信号类型用不同的 bi_gap
**方案**：
- 3B/3S 用较高 bi_gap（需要更确认的结构），如 bg=7
- 2B/2S 用较低 bi_gap（允许更快的趋势追踪），如 bg=4-5
**代码改动**：`_bi()` 返回 bi 信息后，在 `_signal()` 中对不同信号类型检查不同的最小 bi 数量
**预期**：P2601 的 2B 交易不被过滤（bg4），P2201 的 3B/3S 被更严格过滤（bg7）
**风险**：增加参数数量，过拟合风险

### 方案 3：方向感知信号过滤
**失败模式**：P2401 在 Bear 15m 时 2B 做多巨亏 -547
**目标**：只在"顺大势"时做 2B/2S
**方案**：
- 2B（做多）：要求不仅 15m Bull，还要 5m close > 5m MA20
- 2S（做空）：要求不仅 15m Bear，还要 5m close < 5m MA20
- 3B/3S 不加此限制（因为是基于结构的信号，有中枢确认）
**代码改动**：增加 MA20 计算，在 2B/2S 信号检查时加条件
**预期**：大幅减少 P2401 的 2B 逆势做多
**风险**：减少 P2509/P2601 的 2B 交易数（但这些合约的 2B 本来很强，减少一些可能问题不大）

### 方案 4：自适应止损基于入场信号强度
**失败模式**：所有交易用相同的 ATR 止损倍数，但弱信号需要更紧的止损
**目标**：弱信号快止损，强信号宽止损
**方案**：
- 信号强度 = bi_amplitude / ATR
- 高强度（>3 ATR）：使用标准止损
- 低强度（<2 ATR）：止损缩小到 0.7x
**代码改动**：在 `_open_position` 时根据 bi_amp 调整止损距离
**预期**：弱信号快速止损减少 P2401/P2201 的亏损幅度
**风险**：可能过早止损一些最终会盈利的交易

### 方案 5：中枢宽度自适应 pivot_valid_range
**失败模式**：窄中枢产生的信号不如宽中枢可靠
**目标**：对窄中枢信号要求更多确认
**方案**：
- 如果 pivot_width < 1.0 ATR：不产生 3B/3S 信号（只产生 2B/2S）
- 如果 pivot_width > 2.0 ATR：正常产生所有信号
- 中间区域：需要额外确认（如 15m MACD 一致 2 根以上）
**代码改动**：在 `_signal()` 中根据 pivot 宽度调整信号生成条件
**预期**：减少伪中枢（窄中枢=噪声）产生的假信号
**风险**：在窄幅震荡市中完全没有 3B/3S 信号
