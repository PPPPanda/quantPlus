# Iter2 Phase 1: 结构审计（主控初稿）

## 审计范围
基于 iter1 4轮优化后的代码 (`cta_chan_pivot.py`, ~930行)

---

### [1] 分型识别与包含处理
- **代码实现**：左中右3根K线，mid > left & mid > curr → 顶分型；反之底分型。包含关系按 inclusion_dir 合并（向上取高高低高，向下取低高低低）。
- **缠论标准**：包含处理方向应跟随前一笔方向（向上笔→向上包含，向下笔→向下包含），而非简单的"上一根 vs 当前根"比较。
- **偏差**：⚠️ 轻微偏差 — 包含方向初始化为 `1`（默认向上），且基于相邻K线高低判断而非笔方向，可能在笔开始阶段方向判断不准。
- **影响**：低。前几根K线的包含方向可能不准，但后续自然纠正。

### [2] 严格笔构建
- **代码实现**：同向分型取更极值替代（顶取更高、底取更低）；异向需 idx 差 ≥ min_bi_gap=4。
- **缠论标准**：严格笔要求至少5根独立K线（含分型共用K线），即 "至少3根K线在两个分型之间"。代码用包含处理后的K线索引差 ≥ 4 近似。
- **偏差**：✅ 基本一致 — min_bi_gap=4 是对5根K线规则的近似实现，实际效果接近。
- **影响**：低。

### [3] 中枢识别
- **代码实现**：取最近4个笔端点（3笔）计算重叠区。每次新笔形成都可能创建新中枢。无延伸、升级、完成态。
- **缠论标准**：中枢至少3笔有价格重叠，但还应有延伸（后续笔在中枢内振荡）和升级（9笔中枢升级为更高级别）机制。
- **偏差**：❌ 重大偏差 — **中枢数量爆炸**（p2601: 353个中枢 vs 88个交易日），大量"伪中枢"产生无效信号。
- **影响**：高。这是信号质量的核心问题。每次新笔都可能创建中枢，导致 3B/3S 频繁触发。
- **修复建议**：引入中枢合并（与前一中枢重叠>50%时延伸而非新建）——这是 Phase 3 的 B05。

### [4] 3B 买点信号
- **代码实现**：回踩底分型 > ZG（中枢高点），且离开段顶分型也 > ZG，且 15m MACD 金叉。
- **缠论标准**：第三类买点 = 离开中枢后的回踩不回中枢区间。
- **偏差**：⚠️ 轻微偏差 — 代码要求 p_now > ZG（严格不入中枢），缠论要求"不进入中枢区间"（即不低于 ZD 也可接受更宽条件），但代码更严格（> ZG 而非 > ZD），实际上是偏保守的好事。
- **影响**：可能错过一些有效买点（当回踩在 ZG-ZD 之间时）。

### [5] 3S 卖点信号
- **代码实现**：回抽顶分型 < ZD（中枢低点），且离开段底分型也 < ZD，且 15m MACD 死叉且 diff_15m < 0。
- **缠论标准**：第三类卖点 = 离开中枢后的回抽不回中枢区间。
- **偏差**：⚠️ 与 3B 类似的保守实现。额外的 `diff_15m < 0` 是 iter1 新增的空头过滤。
- **关键问题**：**3S 直接开空仓**，而缠论三卖更多是"多头离场信号"。在震荡市中 3S 开空是主要亏损来源。
- **影响**：高（尤其 p2405）。

### [6] 2B/2S 辅助信号（"背驰"）
- **代码实现**：
  - 2B: 底抬高 + diff_5m 增强（p_now.diff > p_prev.diff）+ 15m 多头
  - 2S: 顶降低 + diff_5m 减弱 + 15m 空头且 diff < 0
- **缠论标准**：第二类买卖点基于"力度背驰" — 后一段走势力度弱于前一段。力度可用 MACD 面积衡量。
- **偏差**：❌ 重大偏差 — 代码的"背驰"实际是"**动能增强**"（diff 更大），恰恰相反于缠论定义。
  - 2B 要求 diff 增强 = 动能更强 → 这其实是趋势延续信号，不是背驰
  - 真正的缠论二买应该是：后一段上涨力度弱于前一段（背驰），然后一个不创新低的回踩
- **影响**：中高。2B 在 p2601 是主要盈利信号（趋势延续赚钱），但在震荡市可能过于激进。

### [7] 多级别联立（15m MACD）
- **代码实现**：使用 `prev_diff_15m` vs `prev_dea_15m` 判断多空方向，空头额外要求 diff < 0。
- **缠论标准**：大级别定方向、小级别找买卖点。缠论不局限于 MACD，而是看大级别的趋势/中枢结构。
- **偏差**：⚠️ — 用 MACD 金叉/死叉近似"大级别方向"是常见简化，但可能在趋势转折点延迟或在震荡中频繁翻转。
- **影响**：中。可通过 B04（加强 15m 过滤）改善。

### [8] 止损体系
- **代码实现**：硬止损 ±1 + ATR 移动止损（2.5×ATR 激活，3.0×ATR 追踪）
- **缠论标准**：缠论用结构止损（笔破坏、中枢破坏、分型失效），非固定点位。
- **偏差**：⚠️ — 硬止损 ±1 非缠论原生方法，但 iter1 Round 4 证明 ±1 是最优。ATR 追踪止损是合理的通用方法。
- **影响**：中低。

---

## 关键发现总结

| # | 偏差 | 等级 | 优化潜力 |
|---|------|------|---------|
| 3 | 中枢无状态机，数量爆炸 | ❌ | **高** — 减少伪中枢可大幅提升信号质量 |
| 5 | 3S 开空而非仅平多 | ❌ | **高** — p2405 主要亏损来源 |
| 6 | 2B/2S "背驰"名不副实 | ❌ | **中** — 方向反了但在趋势市意外可用 |
| 1 | 包含方向初始化 | ⚠️ | 低 |
| 4 | 3B 条件偏严 | ⚠️ | 低 |
| 7 | 15m MACD 简单化 | ⚠️ | 中 |
| 8 | 非结构止损 | ⚠️ | 低（已验证最优） |

## 建议 iter2 优先修复
1. **B09: 3S 改为仅平多**（最高优先）
2. **B05: 中枢合并**（第二优先，减少伪中枢）
3. **B04: 15m 过滤加强**（第三优先）
