# Iteration 12 Phase 1 — 结构审计（Claude 主控）

审计目标：对照缠论108课，逐项检查 `cta_chan_pivot.py` 的实现偏差。
审计范围：13合约口径（Wind全量 + p2601）

---

## 审计项1: 分型识别与包含处理

### 实现摘要
- `_process_inclusion()`: 检查相邻K线是否存在包含关系（一根完全包住另一根）
- 包含方向 `_inclusion_dir`: 1=向上（取高高低低）, -1=向下（取低低高高）, 0=未定
- **方向未定时不合并，直接append**（R1修正）
- 方向更新：仅在**无包含**的K线出现时，根据 high/low 的升降关系确定

### 缠论108课要求
- 包含处理方向应由**前一根非包含K线与当前K线的关系**决定
- 向上趋势中：取两K线的高者high、高者low（向上合并）
- 向下趋势中：取两K线的低者high、低者low（向下合并）
- 第62课明确：包含处理方向由前后K线的相对位置决定

### 偏差
1. **⚠️ 方向未定时直接append**：缠论要求第一对K线就应该有默认方向（通常看前序K线走势）。代码在 `_inclusion_dir==0` 时不合并，意味着初始阶段可能出现不该存在的"冗余K线"，影响后续分型判断。
2. **方向更新逻辑正确**：只在非包含K线时才更新方向，符合标准。

### 影响评估
- 初始几根K线的分型判断可能不准，但随着数据积累影响迅速消退
- 对长周期回测（>100根5m bar）影响可忽略

### 建议: **保留**
- 初始化偏差影响极小，修改风险大于收益

---

## 审计项2: 笔构建

### 实现摘要
- `_process_bi()`: 检测顶底分型（3根K线中间最高/最低）
- 严格笔：异向分型间距 ≥ `min_bi_gap`（默认4根包含处理后K线）
- 同向延伸：同类型分型价格更极端时替换（top更高、bottom更低）

### 缠论108课要求
- 第62课/77课：顶底分型必须交替出现
- 严格笔：两端分型之间至少有**独立K线**（非公用K线）
- "至少5根K线"规则（缠师后期修正：顶底分型各3根K线可以共用中间K线，所以最少5根）

### 偏差
1. **✅ 分型交替**：代码通过 `last['type'] == cand['type']` 的同向延伸逻辑保证了分型交替
2. **⚠️ min_bi_gap=4 vs "至少5根K线"**：`min_bi_gap` 是包含处理后K线的 index 差，不是原始K线数。4根间距 ≈ 原始10-20根K线，实际比严格笔的最低要求更宽松。但这个值是策略选择而非实现错误。
3. **⚠️ 分型判断只看3根K线**：代码用 `_k_lines[-3:]` 检测分型，不考虑更远的历史。理论上可能遗漏"延伸"中的中间分型。但增量处理方式下这是工程必然。

### 影响评估
- min_bi_gap=4 是偏保守的选择，减少噪音笔但可能漏掉短周期结构
- 昨天经验：bi_gap 是最敏感参数，bi_gap=7 修好 p2201 但杀死 p2601

### 建议: **保留**
- min_bi_gap=4 在13合约上经过充分测试，不宜轻动

---

## 审计项3: 中枢定义与状态机

### 实现摘要
- `_update_pivots()`: 取最近4个笔端点构成3笔，计算重叠区间
- ZG = min(三笔各自高点) = 重叠区间上沿
- ZD = max(三笔各自低点) = 重叠区间下沿
- 状态机：forming → active → left_up/left_down
- 离开判定：最近一笔的 `bi_low > ZG`（向上离开）或 `bi_high < ZD`（向下离开）
- 延伸：笔仍在 [ZD, ZG] 范围内 → active

### 缠论108课要求
- 第17-18课：中枢由至少3笔重叠区间构成
- 第38课：中枢延伸——第4笔回到中枢区间内，中枢延伸（可能扩展ZG/ZD）
- 中枢升级：9笔以上的中枢可升级为更大级别
- 离开段：一笔完全在中枢之上/之下

### 偏差
1. **🔴 中枢始终用"最近4个笔端点"重新计算**：每次 `_update_pivots()` 都用 `_bi_points[-4:]` 尝试检测新中枢，这意味着中枢会随着新笔不断"滑动重建"。缠论的中枢一旦确认，ZG/ZD 就固定了（除非升级）。
   - **实际影响**：如果中枢 forming → active 后又有新笔，旧中枢可能被新的4笔组合覆盖。但代码中 active 状态直接 return 跳过新中枢检测，部分缓解了这个问题。
   - **真正的问题在 left_up/left_down 后**：离开后如果又形成新的4笔重叠，旧中枢被归档到 `_pivots`，新中枢替代。这是合理的。
2. **⚠️ 中枢不会扩展/升级**：代码的 active 状态只标记"仍在中枢内"，不更新 ZG/ZD。缠论的中枢延伸可能扩展区间，但代码不做这件事。
   - 影响：可能提早判定"离开"（笔突破原始 ZG/ZD 但在扩展后的区间内）
3. **⚠️ 离开判定用最近2笔**：`bi_low = min(bp[-1], bp[-2])`，`bi_high = max(bp[-1], bp[-2])`。这检查的是"最近一笔整体是否在中枢外"，而非"某一段完全离开"。
   - 缠论要求"一笔完全在中枢之上"，代码用2笔的min/max可能不够精确。

### 影响评估
- 偏差1（滑动重建）在 active 状态被保护，实际影响有限
- 偏差2（无扩展）可能导致过早离开判定，影响3B/3S的时机
- 偏差3（2笔判定）逻辑上接近正确——最近一笔端点+前端点的范围就是这一笔的price range

### 建议
- 偏差1: **保留**（active保护机制有效）
- 偏差2: **推迟**（中枢扩展是中等改动，需要单独设计和回测验证）
- 偏差3: **保留**（实际等价于"最近一笔是否完全在中枢外"）

---

## 审计项4: 3B/3S 信号

### 实现摘要
- **3B买点**：`ap['state'] == 'left_up'` + `p_now['type'] == 'bottom'` + `p_now['price'] > ap['zg']` + `is_bull`
  - 含义：向上离开中枢后，出现底分型（回踩低点），该低点高于中枢ZG = 回踩不破
  - S4: 回踩点不能离ZG太远（`max_pullback_atr`）
- **3S平多**：`ap['state'] == 'left_down'` + `p_now['type'] == 'top'` + `p_now['price'] < ap['zd']` + `is_bear`
  - 含义：向下离开中枢后，出现顶分型（回抽高点），该高点低于中枢ZD = 回抽不破

### 缠论108课要求
- 第29课/37课：三类买卖点
- **三买(3B)**：离开中枢后的第一次回踩，不回到中枢区间内（不破ZG）
- **三卖(3S)**：离开中枢后的第一次回抽，不回到中枢区间内（不破ZD）
- 需要配合更大级别趋势方向

### 偏差
1. **✅ 3B核心逻辑正确**：`p_now['price'] > ap['zg']` 精确实现了"回踩不破ZG"
2. **⚠️ 3S只做CloseLong不做Sell**：代码把3S当"平多"信号而非"开空"信号。这是策略选择（只做多），不是实现错误。
3. **⚠️ 没有"第一次"限制**：代码允许离开后多次回踩，每次都可能触发3B。缠论的三买严格说是"第一次回踩"。但通过 `max_pivot_entries` 做了入场次数限制（默认2次）。
4. **⚠️ fallback逻辑**：当中枢处于 forming/active 时，代码用旧逻辑（纯价格阈值 + pivot_valid_range）做3B/3S判断，这不需要"离开"状态。

### 影响评估
- 核心3B逻辑准确，是策略收益的主要来源
- fallback逻辑可能在中枢形成初期产生额外信号（可能是噪音）
- 多次入场通过 entry_count 控制，不算大问题

### 建议: **保留**
- 3B/3S核心正确，fallback是兼容性保障

---

## 审计项5: 2B/2S 信号 — ⚠️ 关键偏差

### 实现摘要
- **2B买点**：`p_now['type'] == 'bottom'` + `p_now['price'] > p_prev['price']`（低点抬高）+ `diff_ok`（MACD diff增强）+ `is_bull`
  - S2闸门：需要 `ap['state'] in ('forming', 'active')`
- **2S平多**：`p_now['type'] == 'top'` + `p_now['price'] < p_prev['price']`（高点降低）+ `diff_ok` + `is_bear`
- `diff_ok` 对于2B = `p_now diff > p_prev diff`（当前底的MACD DIF比前一个底更高 = **动能增强**）
- div_mode=1时(默认): diff_ok OR 面积背驰，取其一即可

### 缠论108课要求
- 第37课/71课：二类买卖点
- **二买(2B)**：第一类买点（底背驰）后的第一次回调不创新低
- 背驰定义：价格创新低/新高，但MACD力度减弱（面积缩小、diff柱子高度降低）
- "底背驰"：价格创新低 + MACD不创新低 → 下跌力度衰竭

### 偏差
1. **🔴 名不副实——2B实际是"趋势延续"而非"背驰"**
   - 代码的2B: 低点抬高 + diff增强 = 上升趋势加速信号
   - 缠论的2买: 底背驰后反弹 + 回调不创新低 = 下跌结束的确认
   - 两者方向一致（都是做多），但触发条件完全不同
2. **⚠️ S6补充路径才是真正的"底背驰"**
   - S6: `price_lower`（创新低）+ `area_div`（面积背驰）= 价格下跌但力度衰减
   - 这更接近缠论的一类买点（底背驰），但代码把它归类在2B下
3. **⚠️ div_mode=1 让 diff_ok OR 面积背驰**
   - 这意味着即使没有面积背驰，只要diff增强就触发
   - 面积背驰（`curr < prev * 0.50`）是非常宽松的条件（要求当前面积小于前同向的50%）

### 影响评估
- **高影响**：2B在多数合约上是主要盈利来源（昨天诊断证实）
- 虽然名不副实，但"低点抬高+动能增强+15m多头"是有效的趋势跟随信号
- S6的真正背驰路径可能有额外价值，但目前被淹没在2B的噪音中

### 建议: **保留但标注**
- 当前2B虽非缠论正统，但回测证明有效，不应修改
- S6补充路径值得单独诊断贡献度
- 建议：在Phase 2中分别统计 2B(diff_ok) 和 2B(area_div) 和 S6(底背驰) 的独立贡献

---

## 审计项6: 多级别联立（15m MACD过滤）

### 实现摘要
- 15m MACD 增量计算，使用 shift(1) 延迟（`_prev_diff_15m / _prev_dea_15m`）
- `is_bull = prev_diff_15m > prev_dea_15m`（15m DIF > DEA = 多头）
- `is_bear = prev_diff_15m < prev_dea_15m`（15m DIF < DEA = 空头）
- 所有信号（3B/3S/2B/2S）都受15m过滤

### 缠论108课要求
- 第99-107课：多级别联立
- 大级别趋势 → 小级别买卖点 → 更小级别精确入场
- "大级别多头"不仅仅是 DIF > DEA，还应考虑：
  - MACD 柱状图的面积趋势
  - 大级别中枢的位置
  - 大级别走势段的方向

### 偏差
1. **🔴 过于简化**：仅用 DIF > DEA 判断多空。这是最基本的MACD用法，远非缠论的"大级别方向一致"
2. **⚠️ 不考虑力度**：15m DIF 仅比 DEA 大 0.01 也判定为多头，没有力度门槛
3. **⚠️ 没有15m级别的中枢/笔分析**：真正的多级别联立需要在15m上也做缠论结构分析

### 影响评估
- 简化的15m过滤是双刃剑：
  - 优点：计算快、避免过拟合
  - 缺点：在趋势转折点可能延迟（DIF还在DEA上方但实际已经转弱）
- 对p2401这类低波动阴跌合约影响大——15m MACD可能长期在0轴附近徘徊，频繁产生虚假is_bull信号

### 建议: **推迟**（中等改动半径）
- 增加15m MACD力度门槛（如 |diff-dea| > threshold）可能有效
- 但15m中枢分析属于高改动半径，暂不推进
- **可在Phase 4试验: 15m histogram > 0 作为额外过滤**

---

## 审计项7: 止损体系

### 实现摘要
- **P1硬止损**: `stop_base - buffer`（buffer = max(pricetick, atr * 0.02)）
- **ATR trailing**: 浮盈 > 2.5*ATR 后激活，止损 = high - 3.0*ATR
- **S7结构trailing**: 激活后优先用最近bottom笔端点 - buffer
- **S5最小持仓保护**: 开仓前2根5m bar止损距离加倍
- **R3锁盈**: lock_profit_atr=0.0（禁用）

### 缠论108课要求
- 缠论不直接定义止损规则，但隐含：
  - 止损应在结构破坏时触发（笔破坏、中枢回归）
  - 三买的止损应在回踩破ZG时
  - 中枢延伸时应重新评估

### 偏差
1. **⚠️ 硬止损不基于结构**：P1止损用 `stop_base - buffer`，其中 stop_base 是回踩点。但如果回踩点刚好在ZG附近，buffer仅 atr*2% ≈ 几个点，非常容易被扫。
2. **✅ trailing逻辑合理**：2.5*ATR激活 + 3.0*ATR跟踪是成熟的趋势跟踪方案
3. **✅ S7结构trailing有创意**：用笔低点作为trailing参考，兼顾了缠论结构和趋势保护
4. **⚠️ S5加倍止损距离只有2根5m bar（10分钟）**：对快速回调的保护有限

### 影响评估
- 硬止损过紧可能导致频繁扫损后再涨回（p2401/p2201的典型失败模式）
- trailing参数（2.5/3.0 ATR）在p2209等大趋势合约上表现好，但在低波动合约上可能永远无法激活

### 建议
- 偏差1: **关注**——Phase 2需诊断"止损后立刻反弹"的频率
- 偏差4: **微调候选**——min_hold_bars 可尝试 3 但需小心（之前 =3 杀p2209）

---

## 汇总：关键偏差优先级

| # | 偏差 | 严重度 | 改动半径 | 建议 |
|---|------|--------|---------|------|
| 1 | 2B/2S名不副实（趋势延续≠背驰）| 高 | — | 保留（有效），但需分项统计贡献 |
| 2 | 15m过滤过于简化 | 中 | 低-中 | 试验力度门槛 |
| 3 | 中枢无扩展/升级 | 中 | 中 | 推迟 |
| 4 | 硬止损过紧 | 中 | 低 | Phase 2诊断后决策 |
| 5 | 初始包含方向未定 | 低 | 低 | 保留 |
| 6 | 3B无"第一次"限制 | 低 | 低 | max_pivot_entries已缓解 |
