# 缠论结构审计（对照缠论108课）— cta_chan_pivot.py

> 审计对象：`src/qp/strategies/cta_chan_pivot.py`（节选逻辑）
>
> 结论导向：该策略整体是“缠论外观 + 简化的分型/笔/中枢框架 + MACD 动能过滤 + ATR 风控”。
> 其中 **2B/2S 被实现为‘动能增强’型顺势确认**，与108课“背驰（力度减弱）”内核不一致，是最关键的结构性偏差。

---

### 审计项1: 分型识别（顶底分型定义、包含关系处理方向）
- **实现摘要**:
  - 分型：在 `_process_bi` 用“三K”法判定：`mid.high > left.high and mid.high > curr.high` 为顶分型；`mid.low < left.low and mid.low < curr.low` 为底分型。
  - 包含：`_process_inclusion` 先判定 `in_last`/`in_new`（新K被旧K包含 or 旧K被新K包含）。若发生包含：
    - 当 `_inclusion_dir==0`（方向未知）直接把 `new_bar` 追加，不做合并；
    - 否则按 `_inclusion_dir` 合并：
      - 上行包含：`high=max(...)`，`low=max(...)`（把 low 抬高）
      - 下行包含：`high=min(...)`，`low=min(...)`（把 high 压低）
    - 合并后把 `datetime/diff/atr/diff_15m/dea_15m` 取最新bar值。
  - 不包含时，用“高高低低同时上移/下移”更新 `_inclusion_dir`（上=1、下=-1），再 append。
- **缠论108课要求**:
  - 分型识别必须建立在**已处理包含关系的K线**之上（去包含后的“标准K线”），并强调分型的有效性、相邻分型间的约束（服务于笔）。
  - 包含处理的核心是：
    1) 必须有明确方向（上涨/下跌）来决定保留高/低的取法；
    2) 方向不明时通常要通过更高一级结构或后续走势来确认，避免把“含糊期”直接进入结构。
- **偏差**:
  1) **方向未知时不合并**：`_inclusion_dir==0` 直接 append，会把包含K线原样进入后续分型判定，导致三K分型被“包含噪声”污染。
  2) 合并时用 `low=max(...)` / `high=min(...)` 是常见的“顺势去包含”写法，但该实现的 `_inclusion_dir` 仅在“同向高高低低”时更新；在震荡或跳空、影线等情况下方向可能长期为0或错误。
  3) 合并后 `diff/atr` 等指标直接取最新bar，造成“合并K线的指标”不是真正的合并指标（可接受工程近似，但不等价于理论K线）。
- **影响评估**:
  - 分型数量与位置会偏移，继而笔、中枢、信号全部受影响；常见结果是：
    - 过多/过少分型（过拟合/漏信号）；
    - 中枢边界（ZG/ZD）漂移；
    - 3B/2B触发频率与胜率不稳定。
- **建议**: **修复**。
  - 给 `_inclusion_dir==0` 的阶段一个可重复的规则：例如以最近一次非包含K线的方向、或以最近两根非包含K线比较确定方向；或延迟处理（暂存）直到出现明确方向再统一合并。
  - 明确“去包含后的K线”才允许进入分型判定。

---

### 审计项2: 笔构建（严格笔规则、min_bi_gap约束、同向延伸）
- **实现摘要**:
  - 笔端点来自分型 `cand`（顶/底）。
  - 若与上一端点同型：只做“同向延伸”——顶取更高、底取更低（替换最后一个端点）。
  - 若异型：要求 `cand.idx - last.idx >= min_bi_gap` 才确认一笔；确认时把当前累计的 `_current_bi_macd_area` 存入 `_bi_macd_areas` 并清零。
- **缠论108课要求**:
  - “笔”不是任意相邻顶底分型连接：需满足严格条件（教材中常以**去包含K线**与**分型有效性**为基础），并处理：
    - 端点之间必须有足够结构（非简单3K即可）；
    - 笔的延伸与反向确认应由“更高/更低的同型分型”与“反向分型成立”共同约束；
    - 常见实现会包含对“破坏/确认”的更严格判定（不仅是间隔bar数）。
- **偏差**:
  1) **笔确认仅靠 min_bi_gap（K线索引间隔）**，没有加入更关键的“结构确认”条件（如端点间必须出现反向分型有效成立、或对极值突破/回撤的约束）。
  2) 分型判定本身是“未必去包含”的三K法（见审计项1），笔的严格性进一步下降。
  3) “同向延伸”替换端点是合理工程手段，但在缠论里通常伴随对“笔是否成立/是否被破坏”的更明确语义；这里替换会让历史笔端点回看重写（repaint）的程度增加。
- **影响评估**:
  - 笔序列可能比理论更“短周期/更敏感”，中枢生成更频繁，信号更密集；
  - 端点替换会导致回测看似更优、实盘实时信号更滞后或更易反复。
- **建议**: **修复**（若目标是“缠论严格结构”）；若目标是“可交易的简化结构”，则需在文档/命名上明确“简化笔”。
  - 增加笔确认规则：例如端点间至少出现一次有效的反向分型且不被包含修正；或在确认新笔前要求对上一笔极值的突破/回撤满足阈值（可用ATR/百分比）。

---

### 审计项3: 中枢定义（3笔重叠区间交集、状态机 forming/active/left_up/left_down）
- **实现摘要**:
  - 新中枢：用最近4个笔点 b0..b3 构造三段区间：
    - r1=|b0-b1|, r2=|b1-b2|, r3=|b2-b3|（用 price min/max）
    - `zg = min(r1.high, r2.high, r3.high)`
    - `zd = max(r1.low,  r2.low,  r3.low)`
    - 若 `zg > zd` 则判定存在三段重叠（交集非空），建立 pivot，state='forming'。
  - 状态机更新：当 active pivot 存在且 state in ('forming','active')：
    - 取最近两笔端点的 price 范围 `[bi_low, bi_high]`；
    - 若 `bi_low > zg` => `left_up`（向上离开）；若 `bi_high < zd` => `left_down`；否则 `active`。
- **缠论108课要求**:
  - 中枢：经典定义为**至少三段（通常对应三笔/三段）走势的重叠区间**，ZG/ZD 为重叠区间上/下沿；并且中枢的延伸、完成、以及离开/回抽的语义与“段/笔”的完成强相关。
  - “离开中枢”通常指：出现**离开段**（离开中枢区间并形成可识别的段/笔），而不是仅靠最新两笔端点范围瞬时判断。
- **偏差**（重点关注项2）:
  1) **离开判定使用“最近两笔端点区间 vs ZG/ZD”**：
     - `bi_low > zg`/`bi_high < zd` 的确在数学上表示“最近这一笔的波动区间完全在中枢上方/下方”，但这更像“价格脱离区间”的瞬时条件；
     - 缠论里的“离开段”通常需要该离开走势本身成为一段/笔并具备可回抽的结构确认。此处未显式要求“离开笔已完成”或“离开后至少形成反向分型确认”。
  2) `forming` 与 `active` 在代码里几乎等价：只要不离开就设为 active，并不断更新 end_bi_idx；缺少对“形成中/完成中枢”的更细粒度语义（例如进入次数、延伸次数）。
  3) 中枢完全基于笔端点 price 的区间交集，未区分“笔内部的高低”与“段的波动范围”（属于简化）。
- **影响评估**:
  - 容易把“刚刚略微脱离中枢”的走势误判为离开，从而提早进入 3B 流程；
  - 3B/3S 可能在离开未确认、或离开很弱时触发，导致假突破后的频繁止损。
- **建议**: **修复**。
  - 离开判定建议加入“离开笔确认”的条件：例如 state 只有在离开后出现一次反向分型并确认离开笔结束，才进入 left_up/left_down；或至少要求离开幅度超过阈值（ATR/百分比）并维持若干bar。
  - `forming` 建议严格限定在“刚构成三段重叠”的阶段，后续进入 `active`；并记录进入次数/延伸笔数用于信号过滤（entry_count 目前未用）。

---

### 审计项4: 3B/3S 信号（离开中枢 + 回踩/回抽不破 ZG/ZD）
- **实现摘要**:
  - 仅当 `ap.state in ('left_up','left_down')`：
    - left_up：若当前最新笔点 `p_now` 为 bottom：
      - `p_now.price > ap.zg` 且（可选）`p_now.price < ap.zg + max_pullback_atr*ATR` 则认为回踩有效；
      - 再叠加 15m MACD 多头 `is_bull` => `Buy`。
    - left_down：若 `p_now` 为 top：
      - `p_now.price < ap.zd` 且 `is_bear` => `CloseLong`（相当于做多的反向退出）。
- **缠论108课要求**:
  - 3B/3S（常见表述为“第三买/第三卖”）核心是：
    1) 中枢形成后出现**离开段**（向上/向下离开中枢）；
    2) 随后出现**回抽/回踩**，但不重新跌回/涨回中枢（不破 ZG/ZD 的某一侧，视买卖点类型）；
    3) 回抽结束后再次转向离开方向，买卖点成立。
- **偏差**（重点关注项3）:
  1) **回踩条件写成 `p_now.price > ap.zg`**：
     - 这表达的是“回踩的低点仍在 ZG 之上”，属于“回踩不破中枢上沿”的一种实现；
     - 但缠论语义上更常用的是“不跌回中枢区间”（即不破 ZG/不进中枢），同时还要强调回抽段自身的完成与转向确认。
  2) `pullback_ok` 的 ATR 上限约束（`< zg + k*ATR`）是工程滤波，不属于108课标准定义；它会把“回踩太浅/太深”的情形硬裁剪。
  3) left_down 分支用于 `CloseLong`，并非对称实现第三卖（更像趋势反转的退出条件），且条件是 `p_now.price < zd`（回抽高点在 ZD 下方）——语义上像“向下离开后向上回抽不进中枢下沿”，但没有开空逻辑。
  4) 离开状态的来源本身偏弱（见审计项3），会传染到3B有效性。
- **影响评估**:
  - 可能把“刚离开/弱离开”的结构也当成可做3B，从而提高假信号；
  - `p_now` 必须是 bottom 才买，等价于“回踩必须形成底分型”，这一点是合理的结构确认，但仍缺少“回踩段完成后再次向上”的二次确认（触发价取 bottom bar 的 high 近似解决，但未要求后续突破）。
- **建议**: **修复**。
  - 在 3B 上补齐“两段确认”：
    - 离开段确认（离开笔/段完成）；
    - 回踩段确认（回踩笔/段完成）+ 再次向离开方向突破触发。
  - `p_now.price > zg` 可以保留为“不回到中枢”的硬条件，但建议允许“短暂刺破/进入”按缠论不同口径配置（严格/宽松）。

---

### 审计项5: 2B/2S 信号（背驰 vs 动能增强）
- **实现摘要**:
  - 仅在 `ap.state in ('forming','active')`（仍在中枢形成/运行期）时：
    - bottom 触发 Buy：要求 `p_now.price > p_prev.price`（价格抬高）且 `p_now.diff > p_prev.diff`（DIF 更强），并通过 `_eval_div_condition(diff_ok)`（看起来只是对 diff_ok 再包装/阈值控制），再叠加 `is_bull`。
    - top 触发 CloseLong：要求 `p_now.price < p_prev.price`（价格降低）且 `p_now.diff < p_prev.diff`（动能更弱），再叠加 `is_bear`。
- **缠论108课要求**:
  - 2B/2S（第二买/第二卖）的核心不是“动能增强”，而是与“背驰/盘背驰”紧密相关：
    - **背驰**：同向推动的后段力度（量能/指标面积/斜率等）**相对前段减弱**，而价格却创出新高/新低（或接近），形成“力度背离”。
    - 第二买常见语义：第一卖后回抽不破关键位并出现背驰/盘背驰确认（具体表述有多种，但“力度减弱”是关键）。
- **偏差**（重点关注项1）:
  1) **代码的 diff 条件与背驰方向相反**：
     - bottom 买点用 `diff_now > diff_prev`（动能增强），并且价格也更高 `price_now > price_prev`，这更像“顺势更强的确认”而非“背驰（力度减弱）”。
     - top 退出用 `diff_now < diff_prev` 且 `price_now < price_prev` 也不是典型“顶背驰”（顶背驰通常是价格创新高但力度减弱）。
  2) 因此这里名为 2B/2S，实为“中枢内/中枢附近的动能顺势加仓/退出门槛”。
  3) `_eval_div_condition(diff_ok)` 在当前片段中看不到其如何实现真正背驰判定；从入参命名看，更像阈值/开关，而非背驰算法。
- **影响评估**:
  - 策略会偏向**追强**而非“背驰低吸/高抛”，在趋势行情可能更顺滑，但在震荡与假突破环境会更容易买在短线高潮附近。
  - 这会使回测表现与缠论买卖点预期（以背驰为核心）完全不同，导致“理论解释-实盘行为”不一致。
- **建议**: **修复（强烈）**。
  - 两种路线二选一，避免“名不副实”：
    1) **若要真正 2B/2S（背驰）**：把条件改为“价格创新低/新高（或至少等价测试）+ 指标力度减弱”。例如：
       - 底背驰：`price_now < price_prev` 且 `diff_now > diff_prev` 并不对；更常见是比较 **MACD 柱面积/能量** 或 DIF/柱子峰值：`price_new_low` 且 `area_now < area_prev`（或柱峰更小）。
       - 顶背驰：`price_new_high` 且 `area_now < area_prev`。
       - 并明确比较的是同向两段（如两次下跌段/两次上涨段）的力度。
    2) **若这是有意的顺势动能策略**：请在代码/文档中改名（例如“2B = 结构内动能确认买点”），避免与缠论术语冲突；并在参数上说明其适用市场（趋势>震荡）。

---

### 审计项6: 多级别联立（15m MACD 过滤是否实现“大级别方向一致”）
- **实现摘要**:
  - 在 `_on_15m_bar` 中把上一根15m的 `diff/dea` 保存到 `_prev_*`，再更新当前15m MACD。
  - 在 `_check_signal` 中仅用 `is_bull = prev_diff_15m > prev_dea_15m` / `is_bear = prev_diff_15m < prev_dea_15m` 作为方向过滤。
- **缠论108课要求**:
  - 多级别联立强调：大级别结构（笔/中枢/趋势）对小级别买卖点的约束，常用方式是“同向中枢/趋势一致、同级别背驰共振”等。
  - 单纯 MACD 金叉/死叉只能代表动能状态，不等价于“上一级别结构方向”。
- **偏差**:
  1) 过滤器是**单一指标单一阈值（DIF>DEA）**，属于动能滤波，并非缠论意义的“级别结构一致”。
  2) 使用 `prev` 值避免未来函数是优点，但仍可能在15m转折初期滞后。
  3) 未把 15m 的“笔/中枢/走势类型”联立到 1m/当前级别结构中。
- **影响评估**:
  - 在趋势行情可减少逆势信号；但在震荡或15m频繁缠绕时，过滤器反复切换，会造成信号忽略/错过或过度交易。
- **建议**: **推迟或分阶段修复**。
  - 若目标是“工程可用”：保留该过滤作为简化版趋势滤波，但明确命名为“15m动能过滤”。
  - 若目标是“缠论级别联立”：需增加15m级别的结构计算（分型/笔/中枢/趋势状态），用其结构方向/中枢位置约束小级别买卖点。

---

### 审计项7: 止损体系（buffer硬编码、ATR移动止损）
- **实现摘要**:
  - 止损采用多阶段：
    - 浮盈<1R：初始止损不动；
    - 浮盈≥1R：可选 lock_profit_atr；
    - 浮盈≥activate_mult*ATR：进入 trailing，`stop = high - trailing_mult*ATR`；
    - 另有 `bi_trailing` 用最近 bottom 作为止损参考（注释表述）。
  - `_check_stop_loss_1m` 有最小持仓保护：`bars_since_entry <= min_hold_bars` 时止损距离加倍。
- **缠论108课要求**:
  - 缠论本身不提供统一的 ATR 移动止损体系；更多是基于结构位（中枢边界、笔端点、关键分型位）进行“结构止损/结构退出”。
  - 工程止损可以叠加，但需与结构信号一致，避免把结构交易变成纯波动止损。
- **偏差**:
  1) 该策略止损核心是 **ATR 波动止损 + 阶段规则**，属于资金管理模块，不是缠论原生。
  2) 若存在硬编码 buffer（片段未给出具体数值，但从描述看存在），可能导致跨品种不可迁移。
  3) `bi_trailing` 若用“最近 bottom”做止损，属于结构止损思路，但需要明确：该 bottom 是哪个级别/哪类 bottom（分型底/笔底/段底）以及何时更新，否则易被“端点替换”导致重绘。
- **影响评估**:
  - ATR trailing 在趋势可锁盈，但在中枢震荡期容易被来回扫；
  - 最小持仓保护会减少刚进场被扫，但也可能放大单笔亏损尾部风险。
- **建议**: **保留 + 局部修复**。
  - 保留 ATR 风控（工程上必要），但建议把“结构止损位”作为主止损：例如 3B 买点止损用回踩低点/不破位（ZG附近）+ buffer；
  - buffer 改为参数化并与品种波动（ATR/合约跳动）联动；
  - 明确 `bi_trailing` 的更新条件，避免端点替换引发止损位漂移。

---

## 针对提问的四个重点答复（摘要）
1) **2B/2S 的“背驰”实现**：当前实现是“diff增强 + 价格更强”的顺势确认，不是108课背驰（力度减弱）。属于**名不副实**，除非作者有意做动能策略，否则建议改名或重写为面积/力度背驰。
2) **中枢离开判定**：用“最近两笔端点区间整体在ZG上方/ZD下方”判离开，偏“瞬时脱离”，不等价于“离开段成立”。建议增加离开笔/段完成确认。
3) **3B 回踩条件 `p_now.price > zg`**：在数学上确实表达“回踩低点不破ZG”，可视为一种严格实现；但仍缺少回踩段完成与再次上破的确认，且依赖离开状态的严谨性。
4) **S6 单笔面积背驰补充路径**：`price_lower(创新低)+area_div(面积背驰)+is_bull` 更接近“底背驰”方向，但它发生在 `has_active_structure`（forming/active）且未绑定“同向两段”的严格对应关系，也未要求结构性转折确认（如回拉不破/再上破）。因此只能算**弱背驰滤波**，不构成108课意义上严格买点。
