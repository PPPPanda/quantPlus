# Iter12 Phase3｜针对 Phase2 失败模式的可落地改动提案（按改动半径：低→中→高）

> 约束回顾：仅做多；不做“全局降频”；每次迭代只动 1–2 个变量/逻辑；13 合约全量回归：TOTAL ≥ 12164pts，所有负合约 > -180pts。
>
> 说明：缠论“108课”在不同流传版本课号可能有偏差；以下标注采用**常见课号体系**并同时给出“原理标题/关键词”，以便对照你手头版本。

---

## 0. 总体策略：用“结构确认 + 波动率门槛 + 风险断路器”分别对四类失败模式拆弹
- **FM-1（合约初期连亏）**：解决“指标未收敛/走势未成型就参与”
- **FM-2（低波动过度交易）**：解决“死亡共振/阴跌小波动中信号失真”
- **FM-3（超长连亏）**：解决“同一错误环境反复试错”
- **FM-4（止损过紧）**：解决“止损落在噪声区，导致小波动频繁被扫”

下文每条都提供：缠论依据 → 代码改动 → 预期影响 → 风险。

---

# A. 低改动半径（优先上车：改动小、回归风险低）

## A1) FM-1 合约初期连亏：增加指标/数据“预热期”（Warmup Gate）

### 1) 缠论依据（108课）
- **“不参与不确定走势”“先确认再介入”**：买点必须建立在已形成的结构之上（中枢/笔/线段的确认），不是指标刚初始化时的“假结构”。
- 常见对应：**关于走势类型/级别与确认**（如：走势必完美、级别、三买/二买的确认逻辑一组课程）。

### 2) 代码改动方案（只改 1 个逻辑开关，不动其它参数）
**目标**：避免合约刚开始/换月初期 EMA/MACD/ATR 未收敛导致连续错误信号。

实现方式（推荐最小侵入）：
- 新增 `indicator_warmup_bars`（默认 `max(30, 3*slowEmaPeriod)`），在 warmup 结束前：
  - **禁止开仓**（但允许计算指标/缓存状态）
  - 或者更温和：只允许“更强确认”的买点（例如必须满足更高一级别背驰/中枢上破后回踩确认）。

**伪代码（TypeScript/Python 都可直接落地）：**
```ts
const warmupBars = Math.max(30, 3 * slowEmaPeriod);
if (barIndex < warmupBars) {
  return { allowEntry: false, reason: 'warmup' };
}
```

如果你的框架能拿到合约起始时间/第一根K：
- 用 `barsSinceContractStart` 替代 `barIndex` 更精确。

### 3) 预期影响
- **改善**：p2201(2021-08)、p2309(2023-04) 这类“合约初期连亏”将显著减少（直接砍掉最不稳定阶段的交易）。
- **可能退化**：极少数合约在上市初期就出现单边趋势（warmup 会错过最初一段）；但通常这段趋势也伴随高波动，后续仍有结构性二买/三买机会。

### 4) 风险分析
- 风险：错过合约初期大行情的“第一段”。
- 缓解：warmup 只屏蔽开仓，不影响后续跟随；且不属于“全局降频”，只作用于合约初期。

---

## A2) FM-4 止损过紧：提高 stop buffer 下限（2% → 5%~8%）

### 1) 缠论依据（108课）
- **止损必须放在“结构被破坏”的位置**：买点失效的判据是结构破坏（例如回抽不成、前低/中枢下沿被有效跌破），而不是被噪声扫掉。
- 常见对应：**买点、止损点与有效跌破**（“有效性”“结构破坏才止损”一组）。

### 2) 代码改动方案（只改 1 个变量：`stop_buffer_atr_pct`）
当前：`stop_buffer = ATR * 0.02`（在低波动时极小，导致频繁扫损）。

建议两档，按回归风险从低到高：
1) **保守档（优先）**：`stop_buffer_atr_pct: 0.02 → 0.05`
2) **进取档（若仍被扫）**：`0.05 → 0.08`

实现不改结构，只改参数：
```py
stop_buffer = atr * stop_buffer_atr_pct
```

可选的小增强（仍算“同一逻辑修改”，不额外引入新参数）：
- 增加最小缓冲：`stop_buffer = max(atr * pct, minTick * 2)`（minTick 可从合约规格读取）

### 3) 预期影响
- **改善**：p2401（低波动阴跌时被噪声扫损）会减少“无意义小止损”，单笔容错提升，有助于提升盈亏比。
- **可能退化**：在震荡但波动不低的合约里，止损变大可能让单笔亏损扩大，导致 PF 下降；但如果你的入场结构靠谱，扩大 buffer 往往换来更少的止损触发。

### 4) 风险分析
- 风险：平均亏损扩大、回撤加深。
- 缓解：该改动应与 **FM-2 的低波动过滤** 搭配；否则在“死亡共振”里只是把小亏拉成中亏。

---

# B. 中改动半径（仍建议优先，但需更谨慎回归）

## B1) FM-2 低波动过度交易：引入“ATR 波动率门槛”（Percentile Gate，非绝对值）

### 1) 缠论依据（108课）
- **级别与力度匹配**：在“力度不足/无趋势”的环境里，背驰/买点的成功率会显著下降；应等待“力度/级别”匹配的结构再做。
- **中枢震荡不应追涨杀跌**：中枢内的无效波动是典型“盘整”，需要过滤。
- 常见对应：**力度、背驰、盘整与趋势的区别**（一组）。

### 2) 代码改动方案（1 个新逻辑 + 0~1 个新参数）
**核心选择：用 ATR 的“百分位/分位数”而不是绝对值。**
- 原因：不同合约点值不同、不同年份波动层级不同；绝对 ATR 难以统一阈值。

推荐实现：
- 计算 `atr_norm = ATR / close`（或 ATR/price），然后在滚动窗口 `vol_rank_window`（建议 240~300 bars，约 1 年交易日）上求分位：
  - `atr_pct_rank = percentile_rank(atr_norm, window)` 取值 0~1。
- 设定门槛 `min_atr_pct_rank`（建议从 **0.20** 起步，即过滤最低 20% 波动环境）。

**门槛如何确定（可落地方法）：**
- 在所有合约、全样本上统计 `atr_pct_rank` 与交易期望（PF/avgWin）的关系；通常最低 10~30% 波动区间是“死亡共振”高发区。
- 先用 **0.20** 做第一刀（改动小，风险低），回归后再微调到 0.15/0.25。

**伪代码：**
```py
atr_norm = atr / close
rank = percentile_rank(atr_norm_hist[-N:], atr_norm)  # N=250
if rank < min_atr_pct_rank:
    allowEntry = False   # 只禁开仓，不影响持仓管理
```

关键点：这不是“全局降频”，而是**只在低波动 regime 禁止新开仓**；对趋势合约在高波动阶段（p2209/p2601）几乎不影响。

### 3) 预期影响
- **改善**：p2401 这类低波动阴跌的“过度交易”会显著下降（交易笔数下降、止损触发减少、avgWin 有望提升）。
- **可能退化**：
  - 某些“慢趋势、低波动稳步上行”的合约可能被过滤掉早期入场；但这类行情通常会逐步抬升 ATR 分位，后续仍可参与。

### 4) 风险分析
- 风险：过滤掉一部分有效的低波动启动行情。
- 缓解（不引入额外参数的做法）：
  - 只过滤“开仓”，不影响已有仓位。
  - 或加入一个“结构豁免”：如果出现更高质量信号（例如你定义的三买/中枢上破回踩确认），可 bypass gate（但这算第二个逻辑点，需谨慎）。

---

## B2) FM-3 超长连亏：递进式断路器（Progressive Circuit Breaker）

### 1) 缠论依据（108课）
- **同级别同类型错误不要反复犯**：当市场处于与你系统不匹配的走势类型（例如盘整阴跌/假突破）时，应“退出观望”，等待结构转换。
- 常见对应：**走势类型切换、操作节奏、宁可错过不可做错**。

### 2) 代码改动方案（1 个逻辑修改，不必增加太多参数）
现状：`cb=6 losses / 60 bars`，暂停结束后立即恢复，容易在同一错误环境继续亏。

建议：把断路器从“固定暂停”升级为“递进式暂停”，只新增一个内部状态 `cb_level`（不一定暴露成参数）。

机制：
- 触发条件仍用现有：`losses_in_window >= circuit_breaker_losses`。
- 触发后：
  - `cb_level += 1`（上限 3）
  - `pause_bars = circuit_breaker_bars * 2^(cb_level-1)`（60→120→240）
- **重置条件**（关键）：
  - 任意一次盈利平仓后 `cb_level = 0`；或
  - 连续 X bars 无交易且出现“结构改善”（如 price > EMA 且 atr_pct_rank 回到阈值上方）再归零。

**伪代码：**
```ts
if (lossCount60 >= cbLosses) {
  cbLevel = Math.min(cbLevel + 1, 3)
  cbUntilBar = currentBar + cbBars * (2 ** (cbLevel - 1))
}
if (currentBar < cbUntilBar) allowEntry = false
if (lastTradePnl > 0) cbLevel = 0
```

### 3) 预期影响
- **改善**：p2305 的 12 连亏最可能被打断（第二次触发后直接拉长冷却期，避免“暂停后继续亏”）。
- **可能退化**：若某合约在短期噪声后迅速转为趋势，递进断路器可能导致错过恢复后的第一段；但该代价通常小于连亏扩大的系统性伤害。

### 4) 风险分析
- 风险：对“高频试错→快速捕捉趋势”的模式不友好。
- 缓解：
  - 不改变持仓管理，只影响开仓。
  - `cb_level` 上限 2~3，避免无限拉长。

---

# C. 高改动半径（最后再做：对结构/信号定义有侵入，需更大回归验证）

## C1) FM-2 + FM-4 联动：低波动 regime 下切换“激活/追踪”倍数（动态 ATR trailing 参数）

### 1) 缠论依据（108课）
- **力度不足不应采用同一止盈/跟踪逻辑**：盘整的“伸缩”与趋势的“延伸”不同，跟踪止盈应匹配走势类型。

### 2) 代码改动方案（动 1–2 个变量，但属于机制升级）
当前：
- `atr_activate_mult=2.5`
- `atr_trailing_mult=3.0`

问题：低 ATR 时，activate 触发与 trailing 跟随都“太近”，锁不住利润/容易来回洗。

方案：引入基于 `atr_pct_rank` 的分段参数（不全局降频，而是**同一策略在不同 regime 下参数不同**）：
- 当 `atr_pct_rank < 0.20`（低波动）：
  - 提高 `atr_activate_mult`（如 2.5→3.2），让止盈激活更苛刻，避免小波动内频繁“假激活”。
  - 或降低 trailing 敏感度（如 3.0→3.5）让回撤容忍更大，减少被洗。

为满足“每次只动 1–2 个变量”：
- 迭代1：只做 `atr_activate_mult` 分段
- 迭代2：再做 `atr_trailing_mult` 分段

### 3) 预期影响
- **改善**：p2401 的 avgWin 有望提升（减少在小波动里过早触发/过早出场）。
- **可能退化**：趋势合约若本来依赖较紧 trailing 锁利润，可能出现回吐增大；但仅在低波动分位触发，趋势期影响较小。

### 4) 风险分析
- 风险：参数分段会引入“边界效应”（rank=0.19 与 0.21 行为差异）。
- 缓解：可用线性插值替代硬阈值（但这是更高半径改动）。

---

# D. 针对每个失败模式的“最小改动组合”建议（满足一次只动 1–2 个点）

## 针对 FM-1（合约初期连亏）
- **首选（低半径）**：A1 warmup gate（只禁开仓）
- 若仍有：把 warmup 从 30 提到 `3*slowEMA` 或 50（仍算 1 个变量）

## 针对 FM-2（低波动过度交易）
- **首选（中半径，但强烈推荐）**：B1 ATR 百分位门槛 `min_atr_pct_rank=0.20`
- 备选（更高半径）**：C1 低波动分段调整 activate/trailing

## 针对 FM-3（超长连亏）
- **首选（中半径）**：B2 递进式断路器（level 递增，暂停翻倍）
- 若回归显示过于保守：上限 level=2 或重置条件更宽松

## 针对 FM-4（止损过紧）
- **首选（低半径）**：A2 `stop_buffer_atr_pct 0.02→0.05`
- 若仍被扫：0.05→0.08 或加 `max(minTick*2)` 下限

---

# E. 关键问题专项回答

## E1) ATR 波动率门槛：绝对值 vs 百分位？
- **推荐：百分位（ATR/price 的 rolling percentile rank）**。
- 理由：跨合约、跨年份、跨换月波动水平差异极大；绝对值门槛不可迁移，易伤 p2209/p2601。

**具体落地：**
- `atr_norm = ATR/close`
- `atr_pct_rank = rank(atr_norm, window=250)`
- `min_atr_pct_rank = 0.20` 起步

**阈值如何定：**
- 先用 0.20 做统一初值（过滤最差 20% 波动环境）；
- 回归后观察：被过滤掉的交易是否主要集中在亏损段（尤其 p2401），以及趋势合约收益是否基本不变；
- 再微调到 0.15 或 0.25。

## E2) 止损 buffer 从 2% 提升到多少合适？缠论依据？
- 依据：止损应对应“结构破坏”，而不是噪声；当 ATR 很小时，`2%*ATR` 往往落在噪声区。
- 建议：**先到 5%（0.05）**，若仍频繁扫损再到 **8%（0.08）**。
- 这是一种“把止损从噪声推到结构之外”的工程化近似；最终最好用笔/线段低点等结构止损（但那属于更高半径改动）。

## E3) 递进式断路器机制：暂停时间如何递增？
- 建议：暂停时间按 level 翻倍（指数递增）最简单有效：
  - Level1：60 bars
  - Level2：120 bars
  - Level3：240 bars
- 重置：盈利一次即重置最简单；更稳健可叠加“波动率恢复/结构改善”条件。

---

# F. 建议的回归顺序（尽量保证 TOTAL 不掉、负合约抬升）
1) **A1 warmup gate**（FM-1）
2) **A2 stop_buffer_atr_pct: 0.02→0.05**（FM-4）
3) **B1 min_atr_pct_rank=0.20**（FM-2）
4) **B2 progressive circuit breaker**（FM-3）

每步都遵守：只动 1–2 个点，跑 13 合约全量回归；若 TOTAL 下滑接近阈值，优先回退高半径改动。
