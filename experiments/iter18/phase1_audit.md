# iter18 Phase 1 审计报告

**日期**：2025-02-05  
**审计员**：Claude (iter18-phase1-audit)  
**基线**：iter17 TOTAL=12174.6 pts

---

## 1. iter17 失败复盘

### 1.1 S27 跳空 ATR 自适应 — 为何失败？

**实验设计**：
- 检测 >1.5×ATR 跳空
- 临时放大 ATR 1.5 倍
- 持续 6-24 个 5m bar

**实测结果**：

| 方案 | TOTAL | Delta |
|------|-------|-------|
| Baseline | 12174.6 | - |
| boost_bars=6 | 12063.7 | **-110.9** |
| boost_bars=24 | 11153.3 | **-1021.3** |

**失败根因**：

1. **p2209 无效**：劳动节后信号生成延迟超过 boost 期，S27 没触发
2. **放宽止损 = 单笔亏损更大**：本意是"减少被震出"，实际是"让亏损扩大"
3. **普通跳空也被触发**：非节假日跳空也满足 >1.5×ATR，导致正常交易退化

**教训**：止损参数优化存在天然矛盾——放宽有利于趋势合约但不利于震荡合约。

### 1.2 核心数据发现

| 指标 | 节后交易 | 普通交易 |
|------|----------|----------|
| 交易数 | 9 | 347 |
| **胜率** | **66.7%** | 41.2% |
| 平均盈亏 | **-79.4 pts** | -3.5 pts |

**结论**：节后信号质量无问题，问题是**止损被穿透**时损失极大。

### 1.3 短持仓分析

| 持仓时长 | 交易数 | 总 PnL | 胜率 |
|----------|--------|--------|------|
| <5 bars | 30 | -1870 pts | **0%** |
| 5-50 bars | 280 | -1868 pts | 19.1% |
| >50 bars | 46 | +5816 pts | 55.6% |

**结论**：短持仓是主要亏损来源，<5 bars 全部亏损。

---

## 2. 策略设计文档待研究问题

策略设计文档（docs/strategy_design.md）备注提到 5 个待研究问题：

| # | 问题 | 分析 | 优先级 |
|---|------|------|--------|
| 1 | 节假日前平仓 | ✅ **高价值**：彻底规避节后跳空，而非被动防御 | P0 |
| 2 | 连亏冷却器太简单 | 中等：当前 L1/L2 两层已有基本效果 | P1 |
| 3 | 止盈策略 | 中等：当前只有止损，无主动止盈 | P1 |
| 4 | 做多做空对称性 | 低：iter4 已验证做空不可行，优先级低 | P2 |
| 5 | 豆油数据同类分析 | 低：扩展验证，非当前瓶颈 | P2 |

---

## 3. 新优化方向提案

### 3.1 S29 节假日前主动平仓 ⭐ 最高优先级

**背景**：
- iter17 证明"放宽止损"无法解决节后跳空
- 节后灾难集中在劳动节/国庆等长假
- 马来西亚市场影响，节后开盘易跳水

**设计**：
```python
# 伪代码
MAJOR_HOLIDAYS = [
    ("劳动节", (5, 1)),
    ("国庆节", (10, 1)),
    ("春节", "动态计算"),
    # ...
]

def _should_close_before_holiday(self, bar_dt: datetime) -> bool:
    """检查是否应该节前平仓"""
    next_trading_day = get_next_trading_day(bar_dt)
    # 如果下一个交易日是重大节假日后第一天
    if is_post_holiday(next_trading_day, MAJOR_HOLIDAYS):
        return True
    return False

def _on_5m_bar(self, bar: dict):
    # 在收盘前30分钟检查
    if self._position != 0 and is_near_close(bar['datetime']):
        if self._should_close_before_holiday(bar['datetime']):
            self._close_position("S29_HOLIDAY_CLOSE")
```

**风险与收益**：
- ✅ 彻底避免节后跳空损失（2022劳动节 -1037 pts）
- ❌ 可能错过节后大行情
- 权衡：节后大行情概率 < 节后大亏概率

**预期收益**：+400~600 pts/年

### 3.2 S26 极端跳空安全网 ⭐ 高优先级

**背景**：
- iter17 推荐作为 P1，但未实际测试
- 作为 S29 的补充保护层

**设计**：
```python
# 已在代码中实现，但默认禁用
gap_extreme_atr: float = 3.0       # 极端跳空阈值
gap_cooldown_bars: int = 3         # 观望期

# 触发条件：gap >= 3.0 * ATR
# 效果：
# 1. 强制平仓（如果有持仓）
# 2. 暂停入场 3 个 5m bar
```

**测试计划**：
- 启用 `gap_extreme_atr=3.0, gap_cooldown_bars=3`
- 对比基线回测 7 合约

**预期收益**：+100~300 pts/年（保底措施）

### 3.3 S30 短持仓信号加强 ⭐ 高优先级

**背景**：
- <5 bars 交易 30 笔全亏
- 当前 `min_hold_bars=2` 只是延长保护，没有过滤弱信号

**可能方向**：

| 方案 | 思路 | 预期效果 |
|------|------|----------|
| S30a | 2B 信号加强趋势过滤（15m diff > 0） | 过滤弱 2B |
| S30b | 入场后最小持仓时间（min_hold_bars=3~5） | 已测试，iter7 证明无效 |
| S30c | 信号确认延迟（等 1 根 bar 确认） | 类似 S3，可能杀 p2209 |
| S30d | histogram 递增门（要求 hist 连涨 2 bar） | 过滤假突破 |

**建议**：
- 先分析 <5 bars 亏损交易的信号类型（3B/2B）
- 针对性设计过滤条件

### 3.4 S31 止盈策略（中优先级）

**背景**：
- 当前策略只有止损（P1硬止损 + ATR trailing）
- 没有主动止盈机制

**可能方向**：

| 方案 | 思路 | 复杂度 |
|------|------|--------|
| S31a | 目标位止盈：ZG + N×ATR | 低 |
| S31b | 分批止盈：50% at 1R, 50% trailing | 中 |
| S31c | 时间止盈：持仓 > N 天强制平仓 | 低 |
| S31d | 结构止盈：出现反向中枢时平仓 | 高 |

**建议**：先实现 S31a 目标位止盈，最简单且可量化

### 3.5 S32 连亏断路器优化（中优先级）

**当前状态**：
- L1：2 连亏 → 冷却 20 bar
- L2：7 连亏 → 暂停 70 bar

**可能改进**：

| 方案 | 思路 |
|------|------|
| S32a | 滚动亏损（`dd_window_trades`）| 已实现，参数调优 |
| S32b | 波动率自适应 | 高波动时更严格 |
| S32c | 日内亏损上限 | 单日亏损 > N×ATR 时暂停 |

---

## 4. 关于 S26 的评估

**问题**：S26 极端跳空安全网值得尝试吗？

**分析**：

| 考量 | 结论 |
|------|------|
| 实现复杂度 | 低（代码已存在，只需启用参数） |
| 与 S29 关系 | 互补（S29 主动规避，S26 被动保护） |
| 风险 | 低（只针对极端跳空，不影响正常交易） |
| 预期收益 | 中（作为保底措施） |

**建议**：**值得尝试**

- S29 是"主动撤退"（节前平仓）
- S26 是"被动防守"（极端跳空暂停）
- 两者组合可以形成完整的节假日风控体系

---

## 5. iter18 实施计划

### Phase 2：S29 节假日前平仓
1. 实现中国期货节假日检测（需要假期数据）
2. 实现收盘前平仓逻辑
3. p2209 单合约验证（劳动节场景）
4. 7 合约全量验证

### Phase 3：S26 极端跳空安全网
1. 启用参数 `gap_extreme_atr=3.0, gap_cooldown_bars=3`
2. 7 合约回测对比基线
3. 如有效，与 S29 组合测试

### Phase 4：S30 短持仓优化
1. 诊断 <5 bars 亏损交易的信号分布
2. 设计针对性过滤条件
3. 回测验证

---

## 6. 预期收益汇总

| 优化 | 预期收益 | 风险 | ROI |
|------|----------|------|-----|
| S29 节假日平仓 | +400~600 pts | 可能错过节后行情 | 高 |
| S26 极端跳空安全网 | +100~300 pts | 极低 | 中 |
| S30 短持仓优化 | +200~400 pts | 可能过滤过猛 | 中 |
| **合计** | **+700~1300 pts** | - | - |

如果实现 +950 pts，可将除p2209 从 4648 提升到 5598 pts，接近目标 5600 pts。

---

## 7. 结论

### 核心洞察
1. **S27 失败证明"放宽止损"思路不可行** — 止损参数存在天然矛盾
2. **节后问题的根源是隔夜风险** — 应该主动规避而非被动防御
3. **短持仓是确定性亏损** — 需要加强信号确认

### 推荐实施顺序
1. **S29 节假日前平仓** — 最高 ROI
2. **S26 极端跳空安全网** — 低风险保底
3. **S30 短持仓优化** — 需要更多诊断

### 风险提示
- S29 可能过于保守，需要观察节后行情错过的机会成本
- 建议先在 p2209 单合约验证，再推广到全合约
