# Phase 1: 缠论结构正确性审计报告

## 审计来源
- **不变量测试**：`scripts/test_chan_invariants.py` — 7 合约结构自动检测
- **中枢质量分析**：`scripts/analyze_pivot_quality.py` — 中枢重叠/合并分析
- **GPT-5.2 缠论108课对照**：缠论研究协调代理逐条审计

## 不变量测试结果

| 检查项 | 结果 | 说明 |
|--------|------|------|
| 分型交替（顶↔底） | ✅ 全通过 | 7 合约无违规 |
| 笔间距 ≥ min_bi_gap | ✅ 全通过 | |
| 笔方向一致性 | ✅ 全通过 | |
| 中枢 zg > zd | ✅ 全通过 | |
| 包含处理后无残留 | ✅ 全通过 | |
| **中枢重叠** | ❌ 7/7 违规 | 80-86% 连续中枢互相重叠 |

## 中枢质量深度分析

| 合约 | 原始中枢 | 合并后中枢 | 缩减率 | 重叠率 | 中枢寿命(中位数) |
|------|---------|-----------|--------|--------|----------------|
| P2201 | 394 | 85 | 78% | 85% | 1 笔 |
| P2205 | 365 | 86 | 76% | 82% | 1 笔 |
| P2401 | 360 | 72 | 80% | 86% | 1 笔 |
| P2405 | 363 | 79 | 78% | 86% | 1 笔 |
| P2505 | 256 | 64 | 75% | 82% | 1 笔 |
| P2509 | 510 | 119 | 77% | 83% | 1 笔 |
| P2601 | 367 | 73 | 80% | 84% | 1 笔 |

**关键发现**：
- 中枢的中位数寿命仅 1 笔（每来一笔就产生新中枢，上一个立即被替换）
- 合并重叠中枢后，实际中枢数量缩减 75-80%
- 大量"大中枢"被拆成了碎片（合并后最大的中枢包含 14-18 个原始中枢）

## GPT-5.2 缠论108课对照审计（按影响度排序）

### P0 - 高影响偏差

#### 1. 中枢算法（_update_pivots）— 影响: 高
- **缠论定义**：中枢 = 走势分段后三段重叠 + 延伸/扩展/升级/离开状态
- **代码实现**：滑动窗口取最近3笔交集，无状态机，只看最后一个
- **偏差**：每笔都生成新中枢 → 大量伪中枢 → 3B/3S 参照不稳定
- **数据证实**：80%+ 连续中枢重叠，中枢寿命仅 1 笔

#### 2. 笔的严格定义（_process_bi）— 影响: 高
- **缠论定义**：至少 5 根独立K线（去包含后），有确认/未确认状态机
- **代码实现**：min_bi_gap=4（idx 间距），无笔状态机
- **偏差**：间距 4 ≠ 5 根独立K线；缺少笔的确认机制

#### 3. 2B/2S "背驰"实现方向相反 — 影响: 高
- **缠论定义**：背驰 = 价格创新低/新高，但力度减弱（MACD 面积/柱/斜率变小）
- **代码实现**：diff 增强 = 动能更强 → 这是"趋势加速"，不是"背驰"
- **偏差**：以背驰名义做了动量追随，在末端追击风险极高

#### 4. 3B/3S 信号简化 — 影响: 高
- **缠论定义**：离开中枢 → 回踩/回抽 → 不回中枢 → 次级别完成确认
- **代码实现**：price > ZG / price < ZD（仅价格位置判断）
- **偏差**：缺少"离开—回踩—再启动"事件序列 + 次级别确认；3S 直接开空非缠论严格推论

### P1 - 中-高影响偏差

#### 5. 级别联立 — 影响: 中-高
- **缠论定义**：高级别定方向/中枢位置 → 低级别找精确点（区间套）
- **代码实现**：仅 15m MACD 方向过滤
- **偏差**：MACD 方向 ≠ 高级别走势类型

#### 6. 缺失模块：线段/走势类型/区间套 — 影响: 中-高
- 缠论结构链：K线→分型→笔→**线段→走势类型→中枢→买卖点**
- 代码跳过了线段和走势类型，直接从笔到中枢

### P2 - 中影响偏差

#### 7. 包含处理方向初始化 — 影响: 中
- **偏差**：inclusion_dir 默认=1（向上），应由首个明确结构确定
- 方向更新过于频繁（逐 bar 翻转），应以分型/笔确认驱动

## 改动优先级清单

| # | 改动项 | 影响 | 半径 | 预期效果 |
|---|--------|------|------|----------|
| 1 | 中枢状态机（形成→延伸→离开→确认） | 高 | 中 | 减少伪中枢，3B/3S 信号质量提升 |
| 2 | 笔的最小K线约束 + 确认机制 | 高 | 中 | 减少噪声笔 |
| 3 | 2B/2S 改为真正的背驰判定 | 高 | 低 | 避免末端追击 |
| 4 | 3B/3S 事件序列化 + 次级别确认 | 高 | 中 | 减少假突破信号 |
| 5 | 3S 改为平多而非开空（或增加条件） | 中 | 低 | 降低逆势亏损 |
| 6 | 高级别走势过滤替代 15m MACD | 中-高 | 中 | 减少逆大势操作 |
| 7 | 包含处理方向修正 | 中 | 低 | 分型位置更准 |
