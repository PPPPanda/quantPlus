# iter5 Phase 1: 主控自审报告

## 审计项 1: 分型识别 (_process_inclusion)

**缠论标准**: 包含方向由最近非包含K线的高低关系决定
**当前实现**: `_inclusion_dir=0` 初始默认，遇到包含时 `if dir==0: dir=1`（默认向上）
**偏差 [P1]**: 初始方向未定时默认向上，可能在开头产生假分型
**影响**: 前几根K线的分型可能不准，但随着数据增多影响衰减

## 审计项 2: 笔构建 (_process_bi)

**缠论标准**: 顶底分型交替，两分型间至少1根独立K线（严格笔要5根）
**当前实现**: 
- 分型判断: mid.high > left.high AND mid.high > curr.high → 顶
- 同向延伸: 更高顶替换旧顶，更低底替换旧底
- 异向成笔: 间隔 >= min_bi_gap(4)
**偏差 [P2]**: min_bi_gap=4 是合理近似，缠论严格定义要求"两分型间至少1根独立K线"
**影响**: 轻微，4根间隔在5m级别约20min，足够合理

## 审计项 3: 中枢定义 (_update_pivots)

**缠论标准**: 
- 3笔重叠形成中枢 [ZD, ZG]
- 中枢有延伸（后续笔仍在[ZD,ZG]内）、升级、完成态
- 同级别中枢不重叠 = 趋势；重叠 = 盘整
**当前实现**: 
- 每次新笔取最近4个端点计算重叠区
- **无状态持久化** — 不追踪延伸/离开/回试
- **无重叠检查** — 可能在同一组笔上重复创建中枢
**偏差 [P0]**: 
1. 滑动窗口式 → 每次新笔都可能创建新中枢，中枢不稳定
2. 无法区分"中枢内震荡"和"离开中枢"
3. 3B/3S 判定的中枢可能是"刚形成还在震荡中的"
**影响**: 最高。3B/3S 在中枢内震荡时频繁误触发

## 审计项 4: 3B/3S 信号

**缠论标准**: 
- 3买: 离开中枢向上的一笔 → 回试（回踩中枢区间上沿ZG）→ 不破ZG → 买入
- 需要明确的"离开段"（完全脱离中枢区间的一笔）
**当前实现**: 
- 3B: p_now(bottom) > ZG AND p_last(top) > ZG AND 中枢在近期(pivot_valid_range笔内)
- 3S: p_now(top) < ZD AND p_last(bottom) < ZD → CloseLong(仅平多)
**偏差 [P0]**: 
1. 未要求"离开段"——只检查最近两个端点都在ZG上方，但中枢可能刚形成、尚未有真正的离开
2. pivot_valid_range=6 是时间窗口，非状态驱动
3. p_last 检查不严格——p_last 是"前一极值"未必是"离开段的端点"
**影响**: 高。震荡中的笔可能恰好都在ZG上方但实际未离开中枢

## 审计项 5: 2B/2S 信号

**缠论标准**: 
- 2买: 在第一个下跌中枢的下方形成"不创新低+力度衰减"的底分型
- 需要趋势段内力度递减（背驰）
**当前实现**: 
- 2B: bottom + price_ok(底抬高) + div_condition + is_bull
- price_ok: p_now.price > p_prev.price (底比前底高)
- div_condition(mode=1): diff_ok(当前diff > 前底diff, 即动能增强) OR 面积背驰
- diff_ok 检查的是"MACD diff 增强"而非"力度衰减"
**偏差 [P1]**: 
1. "diff增强"≠缠论"背驰"（方向相反）
2. price_ok 仅比较两个底的价格，未要求创新高/低
3. OR模式过宽——diff增强或面积背驰任一满足就触发
**影响**: 中。在趋势中diff增强通常正确（趋势延续），但在震荡中会产生噪声

## 审计项 6: 15m MACD 过滤

**缠论标准**: 多级别联立需要大级别结构（笔/中枢方向）
**当前实现**: `is_bull = prev_diff_15m > prev_dea_15m`（仅比较diff和dea的大小关系）
**偏差 [P1]**: 
1. 仅用MACD交叉方向代替结构方向
2. prev_(shift 1)引入1根15m的延迟
3. 震荡市MACD频繁交叉→过滤失效
**影响**: 中。强趋势时有效，震荡时基本无过滤作用

## 审计项 7: 止损体系

**缠论标准**: 出场基于结构（分型/笔/中枢破坏）
**当前实现**: 
- P1硬止损: 入场分型的极值 - ATR*0.02(buffer)
- ATR移动止损: 浮盈>2.5ATR激活，回撤3ATR平仓
**偏差 [P2]**: 
1. 纯ATR止损无结构含义
2. 但ATR止损在工程上更稳定，防止极端行情穿透
**影响**: 低。ATR止损是合理的工程妥协

## 偏差汇总（按严重度）

| 编号 | 项目 | 严重度 | 核心偏差 |
|------|------|--------|----------|
| A3 | 中枢无状态机 | P0 | 滑动窗口式，无延伸/离开/回试 |
| A4 | 3B/3S无离开段检查 | P0 | 未要求"完全脱离中枢的一笔" |
| A1 | 包含方向默认向上 | P1 | 初始dir=0时默认1 |
| A5 | 2B/2S背驰定义反向 | P1 | diff增强≠力度衰减 |
| A6 | 15m过滤过于简化 | P1 | MACD交叉≠结构方向 |
| A2 | min_bi_gap=4 | P2 | 合理近似 |
| A7 | ATR止损无结构意义 | P2 | 工程妥协可接受 |
