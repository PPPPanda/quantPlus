# iter5 Phase 3: 修复策略 Backlog

## 基线状态
- 代码: B12 (commit 32070c8)
- 除p2209合计: 2679 pts → 目标 >5600（缺口 2921）
- 负合约: p2301 (-442)

## iter4 红线（不可重复的失败方向）
1. ❌ 做空 → p2209灾难
2. ❌ 全局trade_interval → 伤趋势合约
3. ❌ daily_loss_limit过低 → 拦截好交易
4. ❌ 15m diff>0硬过滤 → p2209变负
5. ❌ AND模式背驰(div_mode=2) → 全FAIL

---

## Backlog（按优先级排序）

### R1: 包含方向初始化修正 [D4] — 低改动
**失败模式** → 初始dir=0默认向上，下跌初期系统性抬高low，分型/笔偏移
**方案** → 不默认方向，等前两根非包含K线确定方向后再做合并
- `_process_inclusion`: dir==0时不合并，直接append
- 第一次出现非包含(high>last.high & low>last.low → dir=1, 反之 dir=-1)后开始正常包含处理
**代码改动点** → `_process_inclusion()` 中 `if self._inclusion_dir == 0: self._inclusion_dir = 1` 改为跳过合并
**预期影响**:
- p2301/p2405/p2509: 正面（下跌期分型更准确）
- p2601: 中性偏正（上涨期影响小）
- p2209: 需验证（极端行情包含较多）
**风险**: 低。最坏情况笔数略减，信号略少

### R2: 中枢状态机 + 离开段确认 [D1+D2] — 中改动
**失败模式** → 无状态机 → 3B/3S无法确认"离开+回抽"结构 → 假信号
**方案** → 引入 pivot 状态机:
```
状态: forming → active → left → finished
forming: 检测到3笔重叠，ZG/ZD已算出
active:  确认中枢成立（第4笔在中枢内或延伸）
left:    某笔完全脱离中枢（向上: low>ZG, 向下: high<ZD）
finished: 离开后形成新中枢或离开方向被破坏
```
- `_update_pivots` 改为维护当前活跃中枢的状态，而非每次append新pivot
- `_check_signal` 的3B条件改为:
  - pivot.state == 'left' 且 pivot.leave_dir == 'up'
  - 当前回踩笔 low > ZG（回踩不破中枢高点）
  - 回踩笔为bottom分型（确认回踩结束）
**代码改动点** → `_update_pivots()` 重写为状态机; `_check_signal()` 3B/3S条件更新
**预期影响**:
- 全合约: 减少假3B/3S，提高信号质量
- p2301: 大幅正面（假突破被过滤）
- p2501: 正面（减少中枢内重复信号）
- p2601: 需验证（可能减少有效信号）
**风险**: 中。状态机逻辑复杂，需仔细验证不变量

### R3: 背驰绑定走势段 [D3] — 中改动
**失败模式** → 2B/2S背驰用p_now vs p_prev比diff，未绑定同级别走势段
**方案** → 背驰比较改为:
- 明确"比较的两段走势"：当前笔段 vs 前同向笔段（间隔2笔）
- 比较维度: MACD面积比（已有_bi_macd_areas）+ 价格创新低/高
- 条件: segB.price更极端 但 segB.macd_area < segA.macd_area * threshold
**代码改动点** → `_check_signal()` 2B/2S部分; `_eval_div_condition()`
**预期影响**:
- p2509: 正面（更准确的背驰=更好的入场时机）
- p2405: 正面（减少假背驰信号）
- p2601: 中性（趋势中背驰少）
**风险**: 中。阈值需要网格搜索

### R4: 退出优化（trailing + 结构止盈）— 低改动
**失败模式** → p2509 avg_win=42.5太低；所有合约"赢的不够大"
**方案** → 双层退出:
1. **结构止盈**: 出现反向3S(CloseLong)时平仓（已有）
2. **改进trailing**: 
   - activate_mult 从2.5降到1.5（更早启动保护）
   - trailing基于5m笔回撤而非固定ATR倍数
   - 或: 分段止盈（浮盈>2ATR平半仓，剩余用trailing）
**代码改动点** → `_update_trailing_stop()` 参数调整; 可选加分段止盈逻辑
**预期影响**:
- p2509: 大幅正面（avg_win提升）
- p2601/p2505: 正面（趋势中持仓更久）
- p2301: 中性（亏损交易trailing不触发）
**风险**: 低。参数调整为主

### R5: 上级别趋势状态（结构性，非指标）— 中改动
**失败模式** → p2301在下跌7.8%中做多=结构性亏损；15m仅diff>dea不够
**方案** → 用5m笔/中枢结构判定趋势状态:
- **下跌趋势**: 连续2个中枢递降（pivot[n].zg < pivot[n-1].zd）
- **上涨趋势**: 连续2个中枢递升（pivot[n].zd > pivot[n-1].zg）  
- **震荡**: 其他
- 下跌趋势中: 禁止做多（或仅允许最强反转信号）
- 震荡中: 降低仓位或要求更强确认
**代码改动点** → `_check_signal()` 增加趋势状态判断; 新增 `_get_trend_state()` 方法
**预期影响**:
- p2301: 巨大正面（-442→0或小正）
- p2405: 正面（震荡期减少做多）
- p2601: 需验证（必须确保上涨趋势不被误判）
**风险**: 中。趋势判定阈值需调优

### R6: 同中枢重复入场抑制 — 低改动
**失败模式** → p2501在同一中枢附近反复2B/3B → 高频磨损
**方案** → 记录每个中枢的入场次数:
- 同一中枢（同ZG/ZD区间）最多允许N次入场（默认2）
- 第N+1次及以后跳过信号
**代码改动点** → pivot记录增加 `entry_count` 字段; `_check_signal()` 增加检查
**预期影响**:
- p2501: 大幅正面（减少30-40笔低质量交易）
- p2601: 中性（趋势中中枢不重复）
- p2209: 需验证
**风险**: 低

---

## 实验顺序（Phase 4 Round 计划）

| Round | 改动 | 预期增量 | 回归检查 |
|-------|------|----------|----------|
| R1 | 包含方向修正 | ⭐⭐ (+100~300) | p2601不退化 |
| R2 | 中枢状态机+离开段 | ⭐⭐⭐⭐⭐ (+500~1500) | 全合约回归 |
| R3 | 背驰绑定走势段 | ⭐⭐⭐ (+200~500) | 2B信号质量 |
| R4 | 退出优化 | ⭐⭐⭐ (+300~600) | avg_win提升 |
| R5 | 趋势状态过滤 | ⭐⭐⭐⭐ (+400~800) | p2601不退化 |
| R6 | 同中枢入场抑制 | ⭐⭐ (+200~500) | p2501交易数降 |

**预计总增量**: +1700~4200 pts（乐观+已有2679=4379~6879，可能达标）

## Phase 3 决策门
- [x] Backlog输出 ✅
- [ ] GPT子代理反馈整合（等待中）
- [ ] 优先级确认
→ 待GPT反馈后确认，进入 Phase 4
