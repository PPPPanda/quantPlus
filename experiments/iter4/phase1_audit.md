# iter4 Phase 1: 结构审计汇总

## 审计方
- **主控 (Claude)**: 通读源码，逐函数审计
- **GPT-5.2 子代理**: 缠论108课逐条对照审计 ✅ 完成
- **Gemini 浏览器**: 提交审计请求，因 relay 断开未获取回复 ⏳

## 偏差清单（合并去重，按优先级）

### P0-1: 中枢无状态机（最高优先级）
- **缠论标准**: 中枢有 forming → active → left 状态演化，包含延伸/离开/回试
- **当前实现**: 每次新笔都重算最近3笔的交集，无状态持久化
- **影响**: 3B/3S 在中枢内震荡时频繁误触发（p2301 主要亏损来源）
- **修复方向**: 最小状态机（forming/active/left），离开后才允许回试触发3类点
- **风险**: 高（信号时点和频率会显著变化）
- **预期收益**: ⭐⭐⭐⭐⭐（p2301/p2509 受益最大）

### P0-2: 3B/3S 判定过于宽松
- **缠论标准**: 需要"离开段 → 回试 → 不破ZG/ZD → 再确认"的完整序列
- **当前实现**: 仅检查"两个相邻分型都在ZG之上/ZD之下"
- **影响**: 中枢内部波动也能触发信号，震荡合约严重受损
- **修复方向**: 必须先识别"离开中枢"的一笔，再允许回试触发
- **风险**: 中高
- **预期收益**: ⭐⭐⭐⭐（减少假3类点）
- **依赖**: P0-1 状态机

### P0-3: 包含处理方向初始默认向上
- **缠论标准**: 方向由最近非包含K线的高低关系确定
- **当前实现**: `_inclusion_dir = 0` 默认当向上用
- **影响**: 开头和横盘段可能产生假分型
- **修复方向**: 初始设为未定(0)，遇到包含时不合并直到方向明确
- **风险**: 中
- **预期收益**: ⭐⭐⭐

### P1-1: 2B/2S 背驰条件过宽 (OR模式)
- **缠论标准**: 背驰需同向走势段创新高/新低但力度减弱
- **当前实现**: div_mode=1 (diff OR 面积背驰)，不要求创新高/新低
- **影响**: 噪声合约信号泛滥（p2301/p2509）
- **修复方向**: OR→AND，增加"必须创新高/新低才评估背驰"约束
- **风险**: 低 ⭐
- **预期收益**: ⭐⭐⭐⭐（低风险高收益，"止血"改动）

### P1-2: 15m MACD过滤过于简化
- **缠论标准**: 多级别联立需要大级别结构（笔/中枢方向）
- **当前实现**: 仅看 prev_diff_15m > prev_dea_15m
- **影响**: 15m震荡时5m信号不受约束
- **修复方向**: 至少加15m笔方向/趋势判断
- **风险**: 中
- **预期收益**: ⭐⭐⭐

### P1-3: 缺少结构性止损
- **缠论标准**: 出场应基于分型/笔/中枢破坏
- **当前实现**: 仅ATR类止损
- **影响**: 正常回试被ATR扫出，真失败信号又走得慢
- **修复方向**: 加"跌破ZG/ZD即平仓"的结构止损
- **风险**: 低
- **预期收益**: ⭐⭐⭐（减少尾部亏损）

### P2-1: min_bi_gap=4 固定硬编码
- **缠论标准**: 笔的有效性由结构（分型交替+足够波动）决定
- **当前实现**: 异向成笔需间隔≥4根包含处理后K线
- **影响**: 快速反转时笔延迟，窄幅震荡时笔被压缩
- **修复方向**: 改为ATR/波动率自适应
- **风险**: 中高
- **预期收益**: ⭐⭐

### P2-2: pivot_valid_range=6 固定窗口
- **缠论标准**: 中枢有效性由状态演化决定
- **当前实现**: 中枢在笔端点超过6个后可能失效
- **影响**: 慢波动合约中枢过早失效
- **修复方向**: 改为状态驱动失效（依赖P0-1）
- **风险**: 低
- **预期收益**: ⭐⭐

## 修复优先级排序（按 风险低×收益高 优先）

| 优先级 | 编号 | 改动 | 风险 | 收益 | 依赖 |
|--------|------|------|------|------|------|
| 1 | P1-1 | 2B/2S: OR→AND + 创新高/低约束 | 低 | ⭐⭐⭐⭐ | 无 |
| 2 | P1-3 | 加结构止损(破ZG/ZD平仓) | 低 | ⭐⭐⭐ | 无 |
| 3 | P0-3 | 包含方向: 未定→等明确 | 中 | ⭐⭐⭐ | 无 |
| 4 | P0-1 | 中枢状态机(最小可行版) | 高 | ⭐⭐⭐⭐⭐ | 无 |
| 5 | P0-2 | 3B/3S: 必须先有离开段 | 中高 | ⭐⭐⭐⭐ | P0-1 |
| 6 | P1-2 | 15m笔方向过滤增强 | 中 | ⭐⭐⭐ | P0-1 |

## 当前基线
- 7合约总pts: 9788.6 (PASS)
- 除p2209的6合约: 2678.9 (目标>5600, 差2921)
- 负合约: p2301 (-604.9)

## 关键差距分析
要达到5600目标，需从当前2678.9提升2921pts：
- p2301翻正(+605→至少0) 贡献 ~600
- p2501/p2509/p2405提升: 需各增~400-800
- 理想情况: 减少假信号→降频→减少手续费/滑点→各合约均受益
