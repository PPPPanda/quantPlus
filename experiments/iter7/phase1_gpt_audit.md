# iter7 Phase 1 结构审计（缠论108课对照）— cta_chan_pivot.py

> 审计范围：`src/qp/strategies/cta_chan_pivot.py`（当前文件实现的“包含处理→分型→严格笔→中枢状态机→3B/3S + 2B/2S + 15m MACD过滤→风控”链路）
> 
> 参考迭代经验：`experiments/iter6/phase3_backlog.md`（核心结论：微调参数收益有限，需要结构性改变；红线：不做空、不全局降频、不紧trailing、不15m硬过滤）

---

## 审计项1: 5m K线包含处理（含方向判定）
### 当前实现
- 5m bar 增量合成后，进入 `_process_inclusion()`：
  - 若新K与上一根存在包含（`in_last` 或 `in_new`）：
    - 若 `_inclusion_dir==0`（方向未定）→ **不合并，直接 append**
    - 否则按方向合并：
      - dir=1（向上）：`high=max(high)`, `low=max(low)`
      - dir=-1（向下）：`high=min(high)`, `low=min(low)`
  - 若无包含：根据新K相对上一K的高低点同时抬高/同时降低来更新方向。

### 缠论标准（108课）
- “包含关系处理”是分型/笔的前置条件：
  - 包含处理后得到的“处理后K线”应形成清晰的上/下走势，避免“包含未处理导致的假分型”。
  - 方向（向上/向下）应能在包含序列内持续一致，直到出现反向证据（如高低点同时反向）。
  - 包含处理应确保用于分型判断的K线序列**尽量无包含**或包含已按规则消解。

### 偏差分析
- **方向未定时遇到包含直接 append**：会在“处理后K线”序列中保留大量包含K线，使后续分型判定（3根K）出现：
  - 假分型/漏分型（尤其在震荡、跳空、长影线时）
  - 分型出现位置偏移，进一步导致笔端点偏移
- 合并方式采用 `low=max`（向上）/`high=min`（向下）属于常见实现，但**缺少对“新K是内包含还是外包含”的更细粒度处理**，可能在极端影线下使合并K偏离实际波动区。

### 改进建议
- 结构性但低改动：将“方向未定+包含”从“直接append”改为“延迟合并缓冲区（pending include set）”。
  - 具体：当 `_inclusion_dir==0` 且发生包含时，把K线放入临时队列，直到出现第一根非包含K来确定方向，再对队列做一次性合并输出。
  - 保持红线：不改变交易频率的“全局阀门”，而是提升基础结构质量。
- 增加“包含消解后不允许连续包含残留”的断言/调试计数：若处理后K线中连续 N 根仍互含，记录到debug，便于定位 p2501 的过度触发源。

### 预期影响
- 对过度交易合约（p2501）显著：减少假分型→减少假笔→减少假中枢/假2B。
- 风险：处理后K线减少会让信号略滞后（更“钝”），但属于结构质量提升，通常收益>成本。

---

## 审计项2: 分型识别（顶/底分型与有效性）
### 当前实现
- `_process_bi()` 中用处理后K线的三根：left/mid/curr 判定：
  - 顶分型：`mid.high > left.high and mid.high > curr.high`
  - 底分型：`mid.low < left.low and mid.low < curr.low`
- 不处理相等情况（`>=`/`<=`），也未做“分型有效性”校验（如分型间距、包含残留、分型强弱等）。

### 缠论标准（108课）
- 分型不仅是“3根K的高低点关系”，还依赖“包含处理后”的有效K序列。
- 常见工程化标准（贴近108课精神）：
  - 允许等高/等低的处理规则（特别是期货常见一字/平顶平底）
  - 分型需避免在包含未完全消解时直接认定
  - 分型之间的有效性与后续成笔规则强相关（分型不是孤立的）。

### 偏差分析
- 等高/等低未处理 → 在平顶平底、跳空回补等场景漏分型，导致笔端点偏移。
- 分型有效性缺失 → 与当前“方向未定包含直接append”叠加，会显著放大“假分型”。

### 改进建议
- 引入“等价极值”策略：
  - 顶分型：允许 `mid.high >= left.high and mid.high >= curr.high`，但若等高则用 `mid.low`/实体等附加条件区分（避免太松）。
  - 底分型同理。
- 增加“分型产生前的包含残留检查”：若 `mid` 与 `left` 或 `curr` 仍互含，优先延迟判定。

### 预期影响
- 对 p2509/p2505（偏弱但非极端高频）更多是提升信号稳定性与止损合理性。
- 风险：规则变松可能增加分型数量，但只要笔规则严格，最终信号不一定增多。

---

## 审计项3: 笔构建（严格笔规则 + min_bi_gap）
### 当前实现
- 笔端点 `_bi_points` 直接存分型点（top/bottom）。
- 同类分型出现时做“同向延伸”：
  - 顶：更高则替换
  - 底：更低则替换
- 异类分型出现时，若 `cand.idx - last.idx >= min_bi_gap` 则确认成笔。

### 缠论标准（108课）
- “笔”建立在有效分型基础上，常用工程化版本还要求：
  - 笔的高低点应**穿越**（至少要摆脱前一笔的影响），避免微小抖动构成假笔
  - 对“端点替换”的触发条件更严（例如必须破坏前一分型结构）
  - min_bi_gap 本质是对噪声的约束，但不应替代“笔的结构条件”。

### 偏差分析
- 当前实现把“严格笔”几乎等同于“分型交替+间隔>=min_bi_gap”。
  - 在高噪声合约/阶段（p2501）会生成大量短笔
  - 笔的“力度/结构”不够，导致后续中枢非常多、非常碎，进而诱发过度交易
- 未显式处理“缺口/跳空”对笔的影响（期货常见），端点替换可能出现不符合肉眼缠论画法的情况。

### 改进建议
- 结构性改造（中等改动，但仍在“笔层”）：引入“笔确认条件 = 分型交替 + min_bi_gap + 突破过滤”。
  - 例：确认新笔端点前，要求价格至少突破/跌破上一笔端点一定比例（可用 ATR 或固定tick，但注意红线不紧trailing≠不许用ATR做结构过滤）。
- 将 `_bi_points` 从“分型点列表”升级为“笔对象列表”，每笔包含：start_idx/end_idx/start_price/end_price/direction/length/real_range 等，为后续真正背驰/走势段准备数据结构。

### 预期影响
- p2501：减少碎笔→减少信号；但这是“结构过滤”，不是全局降频（符合红线）。
- p2301：更少在噪声段反复止损。
- 风险：可能削弱 p2209（大趋势合约）早期入场，但可通过“仅对2B通道更严、3B保持”降低风险。

---

## 审计项4: 中枢定义（3笔重叠）与状态机（forming/active/left_up/left_down）
### 当前实现
- `_update_pivots()` 维护 `_active_pivot`，并把归档的中枢放入 `_pivots`。
- 新中枢检测使用最近4个笔端点 b0..b3，计算3个“笔区间” r1,r2,r3（相邻端点构成的价格区间），
  - `zg = min(r1.high, r2.high, r3.high)`
  - `zd = max(r1.low, r2.low, r3.low)`
  - 若 `zg > zd` 则认为存在三段重叠，形成新中枢，state='forming'
- 活跃中枢延伸/离开判定：
  - 若最新一笔的整个区间都在中枢上方（bi_low > zg）→ left_up
  - 若最新一笔整个区间都在中枢下方（bi_high < zd）→ left_down
  - 否则 state='active'

### 缠论标准（108课）
- 中枢的本质：连续三段走势（常以三笔/三段近似）价格区间的交集。
- 中枢扩展/延伸：后续走势段回到中枢区间内则构成延伸；离开后形成新的中枢则进入新的级别/新结构。
- “离开”强调的是走势段意义上的离开，而不仅是某一笔的高低点关系；工程上可用“整笔不回中枢”近似，但需要防止误判。

### 偏差分析
- 结构上基本贴近“三笔重叠”的工程定义，但存在两个关键偏差：
  1) **中枢区间固定不更新**：forming/active 的延伸过程中，代码不更新 zg/zd（也未维护 GG/DD/中枢震荡的更高层信息）。在某些行情下，中枢实际“有效震荡区”会收敛或扩张，固定 zg/zd 会导致：
     - 过早判定 left_up/left_down（假离开）
     - 或迟迟不判定离开（假留中）
  2) forming→active 的判定过于宽松：只要不“整笔离开”，就 active，缺少“第4笔仍与中枢交叠”的明确判定。

### 改进建议
- 结构性改造（中改动）：把 pivot 状态机升级为“带区间更新/约束”的版本：
  - forming：由前三段交集确定 core(zg,zd)
  - active：要求新笔与 [zd,zg] **存在交叠**（而不是仅仅没有整笔离开）
  - active 中可维护：
    - `gg`/`dd`（中枢扩展的上/下界）
    - `core_zg/core_zd`（不变）与 `work_zg/work_zd`（可变，反映最近N笔交集）
  - 离开：用“连续两笔确认离开”替代“一笔整段离开”，降低假离开（尤其对 p2501）。

### 预期影响
- p2501：中枢状态稳定 → 3B/2B触发减少、质量更高。
- p2301：假离开减少 → 减少逆势/震荡止损。
- 风险：离开确认更慢，可能错过少量急拉行情的早段利润，但一般会换来更少止损。

---

## 审计项5: 3B/3S 信号（离开中枢 + 回踩/回抽不破ZG/ZD）
### 当前实现
- 仅当 `_active_pivot.state in ('left_up','left_down')` 时，生成“状态机驱动”的 3B/3S：
  - 3B：left_up 后，若当前端点为 bottom 且 `bottom_price > zg` 且 15m 多头（prev_diff>prev_dea）→ Buy
  - 3S：left_down 后，若当前端点为 top 且 `top_price < zd` 且 15m 空头 → CloseLong
- 仍保留历史 pivot 的 fallback：用 `pivot_valid_range` 控制“离开后的有效期”。

### 缠论标准（108课）
- 第三买卖点核心：
  - 必须先离开中枢形成一段趋势（离开段），再回到中枢边界附近不破关键位（ZG/ZD）形成确认。
  - 回踩/回抽的“结构”往往对应次级别的背驰/盘整背驰等（这里可工程简化，但不应完全缺失）。

### 偏差分析
- 3B/3S 的“结构约束”不足：仅用“回踩点价格不破ZG”作为确认，缺少对回踩段内部结构（至少次级别的力度衰竭、或回踩段不构成反向离开）的判定。
- `trigger_price` 使用 `p_now['data']['high']`（回踩分型bar的 high）近似突破确认，但缺少“回踩完成后向上第一笔/第一段确认”的概念，可能导致回踩过程中反复触发（靠 dedup/entry_count 在风控层补救）。

### 改进建议
- 在不触碰红线的前提下，把 3B 从“点条件”升级为“结构两步确认”：
  1) 回踩bottom形成且 >ZG（不破）
  2) 回踩结束后出现一笔向上（或至少一根处理后K突破回踩段高点），才设置 pending Buy。
- 对 3S 同理，增加“回抽结束后向下确认”。

### 预期影响
- p2501：减少回踩过程中重复触发 → trades 降、胜率升。
- p2509/p2505：可能提升单笔平均盈利（更靠近真正趋势恢复点）。
- 风险：入场更慢；需要结合退出优化弥补。

---

## 审计项6: 2B/2S 信号（背驰定义）
### 当前实现
- 2B（Buy）：当前 bottom 比前 bottom 抬高（`price_ok`），同时 diff 增强（`diff_ok`），并通过 `_eval_div_condition()` 允许“diff/面积背驰”混合：
  - baseline：`p_now.diff > p_prev.diff`
  - 面积背驰：比较当前笔段 MACD histogram 面积 vs 前同向笔段（间隔2）面积
- 2S（CloseLong）对称：top 降低 + diff 减弱。

### 缠论标准（108课）
- 第二买卖点不是“趋势延续确认”，而是更偏“回调/反抽结束后的再介入”，常与背驰（力度衰竭）绑定：
  - 背驰比较对象通常是**同向走势段/笔/线段**的力度（MACD面积、柱子、成交量等），且应在“走势结构”框架下比较。
  - 仅用 diff 单点大小做背驰判断不够稳健。

### 偏差分析（重点）
- 当前 2B/2S 更像“diff增强 + 低点抬高/高点降低”的**趋势跟随加仓/追随**条件，而非缠论标准背驰。
- 这会直接导致：
  - 在震荡市（尤其多中枢/碎笔）中产生大量“看似趋势延续”的信号 → p2501 过度交易
  - 在下跌趋势反弹（p2301 的亏损场景）中，也可能在弱反抽里不断做多止损

### 改进建议
- 结构性改变（高收益但中等改动）：把 2B/2S 从“单点diff比较”改为“走势段背驰框架”：
  1) 明确比较对象：以“离开中枢后的走势段”或“同级别线段”作为力度单元（至少在代码层引入 segment 概念：由若干笔构成同向段）。
  2) 背驰判断：比较同向段A与段B（如第二段创新低但MACD面积更小）
  3) 2B触发位置：背驰段结束后的反向笔确认（避免背驰未完成就买）。
- 若短期必须兼容现有实现：
  - 将现有 2B 限制为“只在 active/left_up pivot 结构存在时作为补充”，即没有中枢结构时不做 2B（减少无中枢的追随交易）。这属于结构闸门，不是全局降频。

### 预期影响
- p2501：预计 trades 大幅下降（从“碎笔趋势跟随”回到“结构确认”）。
- p2301：减少弱反弹中反复止损。
- 风险：若2B贡献了某些合约（如p2209）的大趋势加仓利润，改造可能降低其收益；可通过“仅对高频合约启用新2B”做合约分治（不违反红线）。

---

## 审计项7: 多级别联立（15m MACD过滤）
### 当前实现
- 15m bar 增量合成，MACD增量更新；在 5m 信号计算时，用 `shift(1)` 的 15m 值：
  - `is_bull = prev_diff_15m > prev_dea_15m`
  - `is_bear = prev_diff_15m < prev_dea_15m`
- 作为 Buy/CloseLong 的软过滤条件（不是硬 diff>0）。

### 缠论标准（108课）
- 多级别联立核心是“级别结构的嵌套与同向/背驰关系”，不是简单 MACD 金叉/死叉。
- 工程化近似：上一级别处于上升段/离开中枢向上/出现第三买等，才允许下一级别的买点。

### 偏差分析
- 15m 仅用 MACD 线关系过滤，会出现：
  - 结构向上但MACD滞后被挡（错过）
  - 结构震荡但MACD偶尔金叉放行（误入）
- 但好处是符合红线“不15m硬过滤”，当前实现属于“温和过滤”。

### 改进建议
- 结构性改变（中改动）：引入 15m 的“结构过滤”替代/补充 MACD：
  - 在 15m 上用同一套“包含→分型→笔→中枢状态机”生成一个简化结构状态（例如仅维护 active_pivot.state 与最近一笔方向）。
  - 5m 的 3B 买点仅要求：15m 不处于 left_down 或者 15m 最近一段不是明显下跌段（比 MACD 更贴近108课）。
- 保持红线：不做硬过滤（不要求 diff>0），而是“结构不冲突”即可。

### 预期影响
- p2301：若其亏损来自“15m结构向下但MACD偶尔放行”，结构过滤会明显改善。
- 风险：实现复杂度上升，需要更多调试可视化（建议继续使用 ChanDebugger 输出）。

---

## 审计项8: 止损体系（硬止损 + ATR trailing）
### 当前实现
- 开仓止损：以信号的 `stop_base` 为基础（回踩/回抽分型价格），再减/加 buffer：
  - buffer = max(pricetick, atr * stop_buffer_atr_pct)
- 1m 级别硬止损 `_check_stop_loss_1m()`（实盘模式）。
- 5m 级别 trailing `_update_trailing_stop()`：
  - 浮盈 > atr_activate_mult*ATR 才激活 trailing（默认2.5，符合“不紧”红线）
  - trailing 使用 `high - atr_trailing_mult*ATR`（多头）
  - 可选 lock_profit_atr（默认0关闭）。

### 缠论标准（108课）
- 缠论并不以ATR为核心，但“止损应放在结构失效点”是一致的：
  - 买点的失效往往是“回踩低点被跌破/中枢关键位被破坏”。
  - 退出优先级：结构止损 > 保护性止损 > 移动止损。

### 偏差分析
- 止损较贴近“结构失效点 + buffer”，整体合理。
- 主要结构偏差在 trailing：
  - trailing 完全基于 ATR 与 bar high/low，而非“笔/线段低点抬升”的结构方式。
  - iter6 经验也指出：要在不紧trailing的前提下提升 avg_win，需用“基于5m笔低点”的松 trailing。

### 改进建议
- 结构性改变（中改动，符合红线）：把 trailing 从“ATR对高点回撤”改为“笔级别结构 trailing”：
  - 多头：每形成新底分型/新笔确认后，把止损抬到“上一笔底”或“回踩段关键低点 - buffer”。
  - 仍保留 ATR activate 门槛（activate>=2.0），避免过早移动。
- 同时引入“锁盈”Phase（iter6 R3）：浮盈≥1R 将止损抬到 entry+0.2ATR 等小幅锁盈。

### 预期影响
- p2509/p2505：提升 avg_win（更贴结构，让利润跑）。
- p2601（担心受影响）：由于activate门槛不变且 trailing更松，通常风险可控。

---

## 审计项9: 连亏断路器（L1=2/20, L2=6/60）与“为何p2301仍亏”
### 当前实现
- `_update_loss_streak()`：
  - 连亏>=2 → cooldown 20根5m（不重置连亏计数，继续累积）
  - 连亏>=6 → cooldown 60根5m，并将连亏计数清零
- 冷却期间 `_check_signal()` 直接 return，不产生新信号。

### 缠论标准（108课）
- 缠论理论本身不包含“连亏断路器”，但从“走势不利时先观望”的交易原则可引入。
- 关键在于：断路器不应破坏结构逻辑本身，应作为“交易资格闸门”。

### 偏差分析
- 机制本身符合 iter6 backlog 与当前参数设定，但 p2301 仍亏说明：
  - 亏损可能来自“结构性误判导致的高概率止损”，断路器只能截断尾部，不能让每次入场更优
  - 冷却仅阻止新信号生成，但若“pending信号”在冷却前已挂起，仍可能在 1m 上触发（需要检查：当前实现冷却只在 new_bi 后检查；pending 在1m逻辑仍会触发）。这可能造成冷却期内仍成交，从而“看起来被断路器截断但仍继续亏”。

### 改进建议
- 低改动但结构更完整：冷却期间应同时：
  - 取消/冻结 `_pending_signal`（或要求更强触发条件），避免冷却期仍触发旧信号。
- 结构性改变（中改动）：把断路器从“时间冷却”升级为“结构再确认闸门”：
  - L1后：只允许 3B（禁用2B通道）直到出现一次>1R盈利或出现新的有效中枢离开。
  - L2后：暂停+要求下一次必须是“active_pivot left_up 后的第一次回踩3B”，即把恢复条件绑定到结构事件，而非仅时间。
  - 这不属于全局降频，是“亏损合约的局部结构矫正”。

### 预期影响
- p2301：显著减少在错误结构下反复进场；更可能把 -504 拉回到接近0。
- 风险：若 p2301 偶尔靠 2B 获得盈利，禁用2B会错过少量机会，但通常净效益为正。

---

# 结构性改变 Backlog（非微调，按改动半径从低到高）

> 标注格式：**改动** / 预期收益合约 / 风险

1) **冷却期冻结 pending_signal + 冷却期不允许旧信号触发**（补全断路器闭环）  
   - 预期收益：p2301（减少“冷却仍成交”导致的尾部亏损）、p2501（减少连续触发）  
   - 风险：极小（只影响冷却窗口内的信号）

2) **包含处理“方向未定+包含”改为缓冲合并（pending include set）**（提升处理后K质量）  
   - 预期收益：p2501（碎分型/碎笔源头治理）、p2301（震荡假结构减少）  
   - 风险：信号略滞后，可能轻微影响 p2209 早期入场

3) **分型等高/等低与包含残留延迟判定**（分型稳定化）  
   - 预期收益：p2509/p2505（结构更稳定，止损更合理）  
   - 风险：需要小心别放松导致分型过密（靠笔规则兜底）

4) **笔层升级：笔对象化 + “分型交替+min_bi_gap+突破过滤”三重确认**  
   - 预期收益：p2501（降噪降频但非全局）、p2301（减少反复止损）  
   - 风险：实现复杂度上升；可能降低 p2209 的早段捕捉（可仅对2B通道施加突破过滤）

5) **中枢状态机增强：active需交叠确认 + 离开需双笔确认 + 维护core/work区间**  
   - 预期收益：p2501（减少假离开/假回踩）、p2301（过滤震荡伪3B）  
   - 风险：入场更慢；需更多debug回放验证

6) **3B/3S 两步结构确认（回踩完成后再触发）**（从“点条件”到“结构条件”）  
   - 预期收益：p2501 trades显著下降；p2509/p2505 avg_win上升  
   - 风险：错过少量V型急拉

7) **2B/2S 重写为“走势段背驰框架”（segment+力度比较+反向确认）**（最大收益点之一）  
   - 预期收益：p2501（根治过度交易）、p2301（减少弱反弹追随止损）、整体更贴近108课  
   - 风险：改动较大；需要定义“线段/走势段”数据结构与回测对齐

8) **多级别联立结构化：15m也做简化笔/中枢结构，5m只要求结构不冲突**（替代MACD单过滤）  
   - 预期收益：p2301（若亏损来自大级别结构向下时误入）、整体稳定性提升  
   - 风险：计算与调试复杂度大；需要性能与缓存设计

9) **退出结构化：ATR激活门槛不变，trailing改为“基于5m笔低点抬升”的松结构止损 + 1R锁盈**  
   - 预期收益：p2509/p2505 avg_win 提升，向>5600目标推进  
   - 风险：若实现不当可能提前抬止损（需严格遵守“不紧trailing”门槛）

---

## 总结：与 iter6 经验的对齐
- 代码已实现 iter6 R1/R3/R4 的一部分思想（同中枢入场次数、两段式出场框架、止损buffer），但**策略结构核心偏差仍集中在“分型/笔质量”和“2B背驰定义”**。
- 若目标是从 TOTAL=10191pts 中把“弱合约”拉上来并稳定>5600（以 pts/合约更均衡为导向），优先级应是：
  1) 源头降噪（包含/分型/笔）
  2) 2B 结构重写（从趋势跟随改为背驰结构）
  3) 3B 两步确认 + 中枢状态机强化
  4) 退出结构化提升 avg_win（而不是紧trailing）
