# K线图 + 数据录制快速上手

## 5分钟快速开始

### 第1步：启动全功能模式

```bash
cd /e/work/quant/quantPlus
uv run python -m qp.runtime.trader_app --profile all
```

### 第2步：连接CTP模拟盘

1. 确保配置文件存在：`.vntrader/connect_ctp.json`
2. 菜单栏：`系统` → `连接CTP`
3. 等待状态栏显示 `已连接`（约5-10秒）

### 第3步：启动数据录制

1. 菜单栏：`功能` → `数据记录`
2. 在录制器窗口：
   - 点击`添加合约`
   - 输入：`p2505.DCE` （棕榈油2025年5月）
   - 勾选：`☑ Tick数据` 和 `☑ 1分钟K线`
   - 点击`启动`
3. 状态显示 `运行中`，开始录制

### 第4步：查看实时K线

1. 菜单栏：`功能` → `K线图表`
2. 在图表窗口：
   - 合约代码：`p2505.DCE`
   - 时间周期：`1分钟`
   - 点击`确定`
3. K线图开始实时更新

---

## 详细操作演示

### 场景A：盘中实时监控

**目标**：监控棕榈油和螺纹钢的实时走势

```
步骤1：连接CTP（如上）

步骤2：打开多个K线图窗口
  - 窗口1：p2505.DCE（棕榈油，1分钟）
  - 窗口2：rb2505.SHFE（螺纹钢，1分钟）

步骤3：添加技术指标
  - 右键图表 → 添加指标 → MA(5,10,20)
  - 右键图表 → 添加指标 → MACD(12,26,9)
  - 右键图表 → 添加指标 → Volume

步骤4：窗口排列
  - 拖动窗口到屏幕左右两侧
  - 同时监控两个品种
```

**效果**：
```
┌─────────────────┬─────────────────┐
│  棕榈油 p2505   │  螺纹钢 rb2505  │
│  1分钟K线       │  1分钟K线       │
│  MA + MACD      │  MA + MACD      │
│                 │                 │
│  实时更新       │  实时更新       │
└─────────────────┴─────────────────┘
```

---

### 场景B：盘后数据回放

**目标**：回顾今天的交易走势，寻找规律

```
步骤1：不需要连接CTP

步骤2：打开K线图
  - 合约：p2505.DCE
  - 周期：1分钟
  - 时间范围：今日9:00-15:00

步骤3：使用回放功能
  - 点击工具栏 `回放` 按钮
  - 设置回放速度：5倍速
  - 点击 `播放`

步骤4：观察关键时刻
  - 开盘跳空
  - 假突破回落
  - 尾盘拉升
  - 添加备注标记
```

**快捷键**：
- `空格`：暂停/继续
- `↑`：加速回放
- `↓`：减速回放
- `←`：后退10根K线
- `→`：前进10根K线

---

### 场景C：批量录制多品种

**目标**：录制所有关注品种的数据，用于策略回测

```
步骤1：准备品种列表
农产品：p2505.DCE（棕榈油）, m2505.DCE（豆粕）, y2505.DCE（豆油）
黑色系：rb2505.SHFE（螺纹钢）, i2505.DCE（铁矿石）, j2505.DCE（焦炭）
化工：MA2505.ZCE（甲醇）, TA2505.ZCE（PTA）

步骤2：批量添加到录制器
  1. 功能 → 数据记录
  2. 点击 `批量添加`
  3. 粘贴品种列表（每行一个）：
     p2505.DCE
     m2505.DCE
     y2505.DCE
     rb2505.SHFE
     i2505.DCE
     j2505.DCE
     MA2505.ZCE
     TA2505.ZCE
  4. 确定

步骤3：配置录制选项
  ☑ Tick数据（高频策略需要）
  ☑ 1分钟K线（日内策略需要）
  ☑ 5分钟K线（趋势策略需要）

步骤4：启动录制
  - 点击 `全部启动`
  - 确认8个品种都显示 `运行中`

步骤5：设置自动启动（可选）
  - 设置 → 启动时自动录制
  - 勾选已保存的品种列表
```

**数据存储**：
```
录制1天数据量估算：
  Tick数据：50MB/品种 × 8品种 = 400MB
  1分钟K线：10KB/品种 × 8品种 = 80KB
  5分钟K线：2KB/品种 × 8品种 = 16KB

录制1个月数据量（22个交易日）：
  总计：400MB × 22 ≈ 8.8GB
```

---

## 高级技巧

### 技巧1：K线图联动

**场景**：同时查看不同周期，判断趋势

```
打开3个窗口：
  窗口1：p2505.DCE - 1分钟（短期波动）
  窗口2：p2505.DCE - 15分钟（日内趋势）
  窗口3：p2505.DCE - 1小时（中期趋势）

操作：
  - 勾选 `时间轴联动`
  - 在任一窗口拖动，其他窗口同步
  - 在任一窗口缩放，其他窗口同步
```

### 技巧2：画线分析

**场景**：标记支撑阻力位

```
1. 右键图表 → 画线工具 → 水平线
2. 在关键价位拉出水平线
3. 添加文字标注（如"前高阻力8560"）
4. 保存图表（文件 → 保存图表）
```

**常用画线工具**：
- 趋势线：连接高低点
- 水平线：支撑阻力位
- 通道线：价格波动区间
- 斐波那契回调：寻找回调位

### 技巧3：自定义指标公式

**场景**：添加自己的交易指标

```python
# 在 ChartWizard 中添加自定义公式
1. 工具 → 公式编辑器
2. 新建指标：VWAP偏差

公式：
VWAP: SUM(CLOSE*VOLUME, 240) / SUM(VOLUME, 240);
DEVIATION: (CLOSE - VWAP) / VWAP * 100;
UPPER: 2;
LOWER: -2;

输出：
  VWAP: 主图, 颜色=蓝色
  DEVIATION: 副图, 颜色=红绿
  UPPER/LOWER: 副图, 虚线
```

### 技巧4：数据导出到Excel

**场景**：导出K线数据到Excel分析

```python
步骤1：在DataManagerApp查询数据
  合约：p2505.DCE
  周期：1分钟
  时间：2025-01-01 ~ 2025-01-17

步骤2：导出CSV
  - 点击 `导出数据`
  - 选择格式：CSV
  - 保存路径：data/export/p2505_202501.csv

步骤3：在Excel中打开
  - 打开CSV文件
  - 添加公式计算涨跌幅
  - 绘制图表
```

---

## 常见问题排查

### 问题1：K线图不更新

**检查清单**：
- [ ] CTP是否连接成功？（状态栏查看）
- [ ] 合约代码是否正确？（p2505 不是 p00）
- [ ] 是否在交易时段？（夜盘/日盘）
- [ ] 网络是否稳定？

**解决**：
```
1. 重新连接CTP（系统 → 断开 → 连接）
2. 关闭K线窗口重新打开
3. 检查日志（.vntrader/log/）
```

### 问题2：数据录制失败

**错误信息示例**：
```
ERROR: 合约p2505.DCE订阅失败
```

**原因 + 解决**：
```
原因1：合约代码错误
  - 检查：p2505（正确）vs p25（错误）
  - 解决：使用正确的合约代码

原因2：行情网关未连接
  - 检查：状态栏是否显示"已连接"
  - 解决：先连接CTP再启动录制

原因3：数据库权限问题
  - 检查：ls -l .vntrader/database.db
  - 解决：chmod 666 .vntrader/database.db

原因4：磁盘空间不足
  - 检查：df -h
  - 解决：清理旧数据或扩容
```

### 问题3：K线图卡顿

**原因**：加载K线数量过多

**优化方案**：
```
方案1：减少K线数量
  - 设置最大显示：5000根（约20天1分钟）
  - 使用更大周期（5分钟/15分钟）

方案2：减少技术指标
  - 限制：3个以内
  - 删除复杂计算指标

方案3：硬件升级
  - 内存：≥8GB
  - CPU：4核以上
```

---

## 数据备份策略

### 每日备份脚本

```bash
#!/bin/bash
# backup_data.sh

DATE=$(date +%Y%m%d)
BACKUP_DIR="backups/data"

mkdir -p $BACKUP_DIR

# 备份数据库
cp .vntrader/database.db $BACKUP_DIR/database_$DATE.db

# 压缩
gzip $BACKUP_DIR/database_$DATE.db

# 清理30天前的备份
find $BACKUP_DIR -name "*.gz" -mtime +30 -delete

echo "数据备份完成: database_$DATE.db.gz"
```

**设置定时任务**：
```bash
# Linux/Mac
crontab -e
0 2 * * * /path/to/backup_data.sh

# Windows（任务计划程序）
schtasks /create /tn "数据备份" /tr "backup_data.bat" /sc daily /st 02:00
```

---

## 下一步

1. **学习策略开发**：
   - 阅读 CTA策略开发教程
   - 使用录制的数据进行回测
   - 优化策略参数

2. **扩展数据源**：
   - 接入其他数据源（如迅投研）
   - 对比不同数据源质量
   - 数据融合和清洗

3. **实盘交易**：
   - 模拟盘验证策略
   - 小资金实盘测试
   - 逐步扩大规模

---

## 参考资源

- [VeighNa K线图文档](https://www.vnpy.com/docs/cn/chart_wizard.html)
- [数据录制器文档](https://www.vnpy.com/docs/cn/data_recorder.html)
- [技术指标公式大全](https://www.vnpy.com/forum/topic/123-indicators)

---

## 功能实现状态

> 更新时间：2026-01-18

### 已完成功能 ✅

| 功能 | 说明 |
|------|------|
| 启动应用 | `--profile all` 全功能模式 |
| 连接行情网关 | CTP（交易时段）/ TTS（7x24） |
| 数据录制 | vnpy 内置 DataRecorder |
| K线图表显示 | 增强版 EnhancedChartWizard |
| MACD 指标 | 自动显示（DIF/DEA/柱状图） |
| MA 均线指标 | 工具栏添加，12种颜色可选 |
| 成交量显示 | 自动显示在中间栏 |
| 图例显示 | K线图和MACD区域 |
| 多合约查看 | 标签页方式切换 |
| 数据导出CSV | DataManager 内置功能 |

### 未完成功能 ❌

| 功能 | 文档位置 | 计划 |
|------|---------|------|
| 右键菜单添加指标 | 场景A 步骤3 | 当前使用工具栏菜单替代 |
| 多窗口并排显示 | 场景A 步骤4 | 当前使用标签页替代 |
| 数据回放 | 场景B | 下一步计划 |
| 回放快捷键 | 场景B | 下一步计划 |
| 批量添加合约 | 场景C 步骤2 | 当前需逐个添加 |
| K线图联动 | 技巧1 | 下一步计划 |
| 画线工具 | 技巧2 | 下一步计划 |
| 自定义指标公式 | 技巧3 | 下一步计划 |

### 操作方式变更说明

**添加MA指标（增强版）**：
```
原文档：右键图表 → 添加指标 → MA
实际操作：工具栏 → 添加指标 → 均线 MA → 设置周期和颜色
```

**多合约查看（增强版）**：
```
原文档：打开多个窗口并排显示
实际操作：同一窗口内创建多个标签页，点击标签切换
```

---

*文档更新时间：2026-01-18*
