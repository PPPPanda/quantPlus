# iter14 基线参数说明

**验证结果**：TOTAL = 13667.9 pts，12/13 合约通过目标门槛  
**验证日期**：2026-02-05  
**唯一 FAIL**：p2401 = -672.9 pts（结构性问题，全局参数无法解决）

---

## 核心参数（iter14 基线值）

| 参数 | 值 | 说明 |
|------|-----|------|
| `circuit_breaker_losses` | **7** | L2 硬断路器触发阈值：连亏 7 次后暂停交易 |
| `circuit_breaker_bars` | **70** | L2 暂停时长：70 根 5m bar（约 350 分钟） |
| `div_threshold` | **0.39** | 面积背驰阈值：当前笔面积 < 前笔 × 0.39 视为背驰 |
| `max_pullback_atr` | **3.2** | 3B 回踩深度限制：回踩点与 ZG 距离 < 3.2×ATR |

---

## 全部参数详解

### MACD 参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `macd_fast` | 12 | 快线 EMA 周期 |
| `macd_slow` | 26 | 慢线 EMA 周期 |
| `macd_signal` | 9 | 信号线 EMA 周期 |

### ATR 参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `atr_window` | 14 | ATR 计算周期 |
| `atr_trailing_mult` | 3.0 | ATR 移动止损倍数：止损距离 = 入场价 - N×ATR |
| `atr_activate_mult` | 2.5 | 激活 trailing 的浮盈门槛：浮盈 > N×ATR 后启动 |
| `atr_entry_filter` | 2.0 | 入场过滤：触发价与止损距离 < N×ATR 才允许入场 |

### 笔与中枢参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `min_bi_gap` | 4 | 严格笔端点最小间隔（包含处理后的 K 线数） |
| `pivot_valid_range` | 6 | 中枢有效范围（笔端点数），超出则中枢失效 |
| `fixed_volume` | 1 | 每次交易的固定手数 |

### B02/R2: 分层连亏断路器
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `cooldown_losses` | 2 | L1 轻度冷却阈值（0=禁用） |
| `cooldown_bars` | 20 | L1 冷却期（5m bar 数） |
| `circuit_breaker_losses` | **7** | L2 硬断路器阈值（iter14 核心参数） |
| `circuit_breaker_bars` | **70** | L2 冷却期（iter14 核心参数） |

**逻辑**：
- 连亏 2 次 → L1 冷却 20 bar（温和限制）
- 连亏 7 次 → L2 暂停 70 bar（硬停止）

### R3: 两段式出场（iter14 禁用）
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `lock_profit_atr` | 0.0 | 锁盈倍数（0=禁用），浮盈≥1R 时止损抬到 entry + N×ATR |

### S5: 最小持仓保护
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `min_hold_bars` | 2 | 开仓后前 N 根 5m bar 止损距离加宽（×2） |

**目的**：避免入场后立即被噪音止损。

### S4: 3B 回踩深度过滤
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `max_pullback_atr` | **3.2** | 回踩点与 ZG 的最大距离（iter14 核心参数） |

**逻辑**：3B 信号要求回踩点 < ZG + 3.2×ATR，过滤远离中枢的虚假信号。

### S7: 结构 trailing
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `use_bi_trailing` | True | 激活后用笔低点（bottom - buffer）作为 trailing stop |

### B03: 止损 buffer
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `stop_buffer_atr_pct` | 0.02 | 止损 buffer = max(pricetick, atr × 2%) |

### R1: 入场去重
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `max_pivot_entries` | 2 | 同一中枢最多入场次数（0=禁用） |
| `pivot_reentry_atr` | 0.6 | 超限后需突破中枢上沿 + 0.6×ATR 才放行 |
| `dedup_bars` | 0 | 时间去重窗口（0=禁用） |
| `dedup_atr_mult` | 1.5 | 价格去重距离（ATR 倍数） |

### B10: 背驰模式
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `div_mode` | 1 | 0=仅 diff, 1=OR(diff 或面积), 2=AND, 3=仅面积 |
| `div_threshold` | **0.39** | 面积背驰阈值（iter14 核心参数） |

**逻辑**：div_mode=1 时，满足 diff 背驰 **或** 面积背驰任一条件即可触发信号。

---

## 实验性功能（iter14 后添加，已禁用）

以下功能在 iter15-21 中实验，但验证结果不佳，已恢复到禁用状态：

### S8: 走势段背驰（iter8 验证无效）
| 参数 | 值 | 状态 |
|------|-----|------|
| `seg_enabled` | **False** | 禁用 |
| `seg_div_ratio` | 0.82 | - |
| `seg_div_ratio_sell` | 0.78 | - |
| `seg_min_bi` | 3 | - |
| `seg_price_tol` | 0.003 | - |

**结论**：段背驰信号噪声大，无法改善回测结果。

### S9: histogram 确认门
| 参数 | 值 | 状态 |
|------|-----|------|
| `hist_gate` | **0** | 禁用 |

### S26/S26b: 跳空安全网（iter17）
| 参数 | 值 | 状态 |
|------|-----|------|
| `gap_extreme_atr` | **0.0** | 禁用（原值 1.5） |
| `gap_cooldown_bars` | 6 | - |
| `gap_tier1_atr` | 10.0 | - |
| `gap_tier2_atr` | 30.0 | - |

**结论**：跳空检测对整体收益影响有限，且增加复杂度。

### S27: 跳空重置包含方向（iter20 灾难性失败）
| 参数 | 值 | 状态 |
|------|-----|------|
| `gap_reset_inclusion` | **False** | 必须禁用 |

**结论**：启用后 p2209 从 +77k pts 暴跌到 +1.3k pts，绝对禁止使用。

### B28: Bridge Bar（iter21）
| 参数 | 值 | 状态 |
|------|-----|------|
| `bridge_bar_enabled` | **False** | 禁用回到 iter14 基线 |
| `bridge_gap_threshold` | 1.5 | - |

**结论**：整体 +214 pts (+1.7%)，但波动大（9 个合约改善，4 个恶化），暂不采用。

---

## 调试参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `debug` | False | 调试模式开关 |
| `debug_enabled` | True | 启用 Debug 记录 |
| `debug_log_console` | True | 输出到控制台 |

---

## 参数调优历史

| 迭代 | 关键改动 | 结果 |
|------|----------|------|
| iter7 | S2b+S5+S4+S7 结构性改动 | 零亏损合约达成 |
| iter8 | 段背驰实验 | ❌ 无效 |
| iter12 | 13 合约口径基线 | TOTAL 12164→13891 |
| **iter14** | **cb=7/70, div=0.39, mpa=3.2** | **TOTAL=13667.9 ✅** |
| iter15-16 | CB2.0/2.1 增强断路器 | ❌ 伤害趋势合约 |
| iter17 | S26/S26b 跳空安全网 | 效果有限 |
| iter20 | S27 跳空重置 | ❌ 灾难性失败 |
| iter21 | B28 Bridge Bar | +214 pts，波动大 |

---

## 已知问题

- **p2401** 是唯一持续亏损的合约（-672.9 pts）
- 根本原因是结构性问题：该合约需要更严格的断路器，但全局参数会伤害趋势合约
- **推荐方案**：Per-Contract 参数覆盖（未实现）
