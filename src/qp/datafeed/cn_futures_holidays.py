"""中国期货市场节假日数据.

S29: 节假日前主动平仓所需的假期列表。
只包含重大节假日（休市 >= 3 天的假期），以降低错过行情的风险。

数据来源：中国证监会 / 各期货交易所公告
"""

from datetime import date, timedelta
from typing import Set, Tuple

# 直接存储"节前最后交易日" -> 更可靠，避免推算错误
# 格式：{(节前最后交易日, 节假日名称), ...}
# 只包含重大节假日（休市 >= 3 天）：春节、清明、劳动节、端午、中秋、国庆

PRE_HOLIDAY_DATES: Set[Tuple[date, str]] = {
    # 2021年
    (date(2021, 2, 10), "春节"),    # 春节 2/11-2/17，前一交易日 2/10
    (date(2021, 4, 2), "清明"),     # 清明 4/3-4/5，前一交易日 4/2
    (date(2021, 4, 30), "劳动节"),  # 劳动节 5/1-5/5，前一交易日 4/30
    (date(2021, 6, 11), "端午"),    # 端午 6/12-6/14，前一交易日 6/11
    (date(2021, 9, 17), "中秋"),    # 中秋 9/18-9/21，前一交易日 9/17
    (date(2021, 9, 30), "国庆"),    # 国庆 10/1-10/7，前一交易日 9/30
    
    # 2022年
    (date(2022, 1, 28), "春节"),    # 春节 1/31-2/6，前一交易日 1/28
    (date(2022, 4, 1), "清明"),     # 清明 4/2-4/5，前一交易日 4/1
    (date(2022, 4, 29), "劳动节"),  # 劳动节 4/30-5/4，前一交易日 4/29 ⚠️ p2209 灾难
    (date(2022, 6, 2), "端午"),     # 端午 6/3-6/5，前一交易日 6/2
    (date(2022, 9, 9), "中秋"),     # 中秋 9/10-9/12，前一交易日 9/9
    (date(2022, 9, 30), "国庆"),    # 国庆 10/1-10/9，前一交易日 9/30
    
    # 2023年
    (date(2023, 1, 20), "春节"),    # 春节 1/21-1/29，前一交易日 1/20
    (date(2023, 4, 4), "清明"),     # 清明 4/5，前一交易日 4/4
    (date(2023, 4, 28), "劳动节"),  # 劳动节 4/29-5/3，前一交易日 4/28
    (date(2023, 6, 21), "端午"),    # 端午 6/22-6/24，前一交易日 6/21
    (date(2023, 9, 28), "中秋国庆"), # 中秋+国庆 9/29-10/6，前一交易日 9/28
    
    # 2024年
    (date(2024, 2, 8), "春节"),     # 春节 2/10-2/18，前一交易日 2/8 (2/9 调休)
    (date(2024, 4, 3), "清明"),     # 清明 4/4-4/6，前一交易日 4/3
    (date(2024, 4, 30), "劳动节"),  # 劳动节 5/1-5/5，前一交易日 4/30
    (date(2024, 6, 7), "端午"),     # 端午 6/8-6/10，前一交易日 6/7
    (date(2024, 9, 13), "中秋"),    # 中秋 9/14-9/17，前一交易日 9/13
    (date(2024, 9, 30), "国庆"),    # 国庆 10/1-10/7，前一交易日 9/30
    
    # 2025年
    (date(2025, 1, 27), "春节"),    # 春节 1/28-2/4，前一交易日 1/27
    (date(2025, 4, 3), "清明"),     # 清明 4/4-4/6，前一交易日 4/3
    (date(2025, 4, 30), "劳动节"),  # 劳动节 5/1-5/4，前一交易日 4/30
    (date(2025, 5, 30), "端午"),    # 端午 5/31-6/2，前一交易日 5/30
    (date(2025, 9, 30), "中秋国庆"), # 中秋+国庆 10/1-10/8，前一交易日 9/30
    
    # 2026年
    (date(2026, 2, 16), "春节"),    # 春节 2/17-2/25，前一交易日 2/16
    (date(2026, 4, 3), "清明"),     # 清明 4/4-4/6，前一交易日 4/3
    (date(2026, 4, 30), "劳动节"),  # 劳动节 5/1-5/4，前一交易日 4/30
    (date(2026, 5, 18), "端午"),    # 端午 5/19-5/21，前一交易日 5/18
    (date(2026, 9, 25), "中秋"),    # 中秋 9/26-9/28，前一交易日 9/25
    (date(2026, 9, 30), "国庆"),    # 国庆 10/1-10/8，前一交易日 9/30
}

# 为了向后兼容，保留原有的 MAJOR_HOLIDAY_RETURNS
MAJOR_HOLIDAY_RETURNS: Set[date] = {d for d, _ in PRE_HOLIDAY_DATES}


def is_pre_holiday_trading_day(trade_date: date) -> bool:
    """判断是否是重大节假日前最后一个交易日.
    
    Args:
        trade_date: 当前交易日期
        
    Returns:
        True 如果 trade_date 在 PRE_HOLIDAY_DATES 中
    """
    return trade_date in MAJOR_HOLIDAY_RETURNS


def get_holiday_name(pre_holiday_date: date) -> str:
    """获取节假日名称（用于日志）.
    
    Args:
        pre_holiday_date: 节前最后交易日
        
    Returns:
        节假日名称，如果不在列表中返回"节假日"
    """
    for d, name in PRE_HOLIDAY_DATES:
        if d == pre_holiday_date:
            return name
    return "节假日"


# 测试
if __name__ == "__main__":
    # 验证 2022 劳动节场景
    # 4/29 是节前最后交易日 -> 5/5 是节后首日
    test_dates = [
        date(2022, 4, 28),  # 周四
        date(2022, 4, 29),  # 周五，节前最后交易日
        date(2022, 5, 5),   # 节后首日
    ]
    for d in test_dates:
        is_pre = is_pre_holiday_trading_day(d)
        print(f"{d} ({d.strftime('%A')}): is_pre_holiday={is_pre}")
